<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RailModelRegistry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Firebase SDK imports (použijeme globálne window.firebase pre prístup z Babel scriptov) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Sprístupnenie Firebase funkcií globálne pre použitie v Babel skripte
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            getFirestore,
            doc,
            getDoc,
            addDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            collection,
            query,
            where,
            getDocs,
            arrayUnion,
            arrayRemove
        };
    </script>
    <style>
        /* Základné štýly pre celú stránku */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* Zabraňuje horizontálnemu posúvaniu */
            background-color: #f8fafc; /* light slate background */
        }
        /* Štýly pre kontajner náhľadu obrázka */
        .image-preview-container {
            width: 100%;
            height: 200px;
            border: 2px dashed #cbd5e1;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background-color: #f8fafc;
            position: relative;
        }
        .image-preview-placeholder {
            color: #94a3b8;
            font-size: 0.875rem;
            text-align: center;
        }
        /* Štýly pre vlastné nahrávanie súborov */
        .custom-file-upload {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            background-color: #f9fafb;
        }
        .custom-file-upload:hover {
            border-color: #93c5fd;
            background-color: #eff6ff;
        }
        .custom-file-upload.drag-over {
            border-color: #3b82f6;
            background-color: #dbeafe;
        }
        .custom-file-upload input[type="file"] {
            display: none;
        }

        /* Štýly pre vizualizáciu náprav */
        .axle-visualization-wrapper {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-left: 15px;
        }
        .axle-visualization-container {
            position: relative;
            background-color: #d1d5db;
            border-radius: 0.5rem;
            padding: 1rem 0.5rem;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 1rem;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
            min-height: 100px;
            width: auto;
        }
        .axle-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        .axle-bar {
            height: 60px;
            width: 8px;
            background-color: #4b5563;
            border-radius: 4px;
        }
        .wheel {
            width: 40px;
            height: 24px;
            background-color: #ffffff;
            border: 1px solid #6b7280;
            border-radius: 4px;
            position: relative;
            z-index: 10;
        }
        .wheel.bandaged {
            background-color: #ef4444;
        }
        .arrow-indicator {
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-right: 16px solid #3b82f6;
            margin-right: 5px;
        }
        .arrow-text-container {
            display: flex;
            align-items: center;
            color: #3b82f6;
            font-size: 0.75rem;
            white-space: nowrap;
            text-align: center;
        }
        .axle-gap-horizontal {
            width: 2rem;
            height: 1px;
        }
        .wheel-checkboxes-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            background-color: #ffffff;
            border-radius: 0.5rem;
            padding: 0.75rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            align-items: flex-end;
        }
        .wheel-checkboxes {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }
        .wheel-checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .input-short {
            max-width: 150px;
            width: 100%;
        }
        .bandage-info-text {
            text-align: center;
            width: 100%;
        }

        /* Štýly pre tabuľku modelov */
        .model-table-container {
            overflow-x: auto;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .model-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        .model-table th, .model-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        .model-table th {
            background-color: #f1f5f9;
            font-weight: 600;
            color: #334155;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }
        .model-table tbody tr:hover {
            background-color: #f0f9ff;
            cursor: pointer;
        }
        .model-table tbody tr.selected {
            background-color: #dbeafe;
            font-weight: 500;
        }

        /* Štýly pre vizualizáciu návestidla */
        .signal-visualization-container {
            background-color: #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 150px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
        }
        .signal-post {
            width: 10px;
            height: 80px;
            background-color: #4b5563;
            border-radius: 5px;
            margin-top: 10px;
        }
        .signal-light-head {
            background-color: #334155;
            border-radius: 0.5rem;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .signal-light {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #a0aec0;
            border: 1px solid #718096;
        }
        .signal-light.red { background-color: #ef4444; }
        .signal-light.yellow { background-color: #f59e0b; }
        .signal-light.green { background-color: #22c55e; }
        .signal-light.white { background-color: #ffffff; }

        .signal-mechanical-arm {
            width: 60px;
            height: 15px;
            background-color: #ef4444;
            border-radius: 5px;
            transform-origin: left center;
            transition: transform 0.3s ease-in-out;
        }
        .signal-mechanical-arm.up {
            transform: rotate(-45deg);
        }
        .signal-mechanical-arm.down {
            transform: rotate(0deg);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <script type="text/babel">
        // V reálnej aplikácii by sa tieto importovali z 'react'
        const { useState, useEffect, useRef, useImperativeHandle } = React;

        // --- Komponent: common/LabeledInput.js ---
        const LabeledInput = ({ label, id, type = "text", value, onChange, placeholder, options, min, step, required = false, className = "", readOnly = false, spanFull = false }) => {
            const baseInputClasses = "px-3 py-1.5 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-base h-10";
            const combinedInputClasses = `${baseInputClasses} ${className} ${readOnly ? 'bg-gray-100 cursor-not-allowed' : ''}`;
            const labelClasses = "text-gray-700 font-medium text-sm";
            const fileInputRef = useRef(null);
            const [isDragOver, setIsDragOver] = useState(false);

            const wrapperClasses = `flex flex-col gap-1 w-full ${spanFull ? 'col-span-full' : ''}`;

            if (type === "file") {
                const handleDragOver = (e) => {
                    e.preventDefault();
                    setIsDragOver(true);
                };

                const handleDragLeave = (e) => {
                    e.preventDefault();
                    setIsDragOver(false);
                };

                const handleDrop = (e) => {
                    e.preventDefault();
                    setIsDragOver(false);
                    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                        onChange(e.dataTransfer.files[0]);
                    }
                };

                const handleClick = () => {
                    if (!readOnly) {
                        fileInputRef.current.click();
                    }
                };

                return (
                    <div className={wrapperClasses}>
                        <label htmlFor={id} className="text-sm font-medium text-gray-700 mt-2">{label}</label>
                        <div
                            className={`custom-file-upload ${isDragOver ? 'drag-over' : ''} ${readOnly ? 'opacity-60 cursor-not-allowed' : ''}`}
                            onClick={handleClick}
                            onDragOver={handleDragOver}
                            onDragLeave={handleDragLeave}
                            onDrop={handleDrop}
                        >
                            <svg className="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L40 32" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                            </svg>
                            <p className="mt-2 text-sm text-gray-600">
                                <span className="font-medium text-blue-600 hover:text-blue-500">Pretiahnite sem obrázok</span>
                                {' '}alebo kliknite pre vyhľadanie
                            </p>
                            <p className="mt-1 text-xs text-gray-500">JPG, PNG – bude uložený ako .jpg</p>
                            <input
                                type="file"
                                id={id}
                                name={id}
                                ref={fileInputRef}
                                onChange={(e) => onChange(e.target.files[0])}
                                className="sr-only"
                                accept="image/jpeg, image/png"
                                required={required}
                                disabled={readOnly}
                            />
                        </div>
                    </div>
                );
            }

            if (type === "textarea") {
                return (
                    <div className={wrapperClasses}>
                        <label htmlFor={id} className={labelClasses}>{label}</label>
                        <textarea
                            id={id}
                            name={id}
                            value={value}
                            onChange={onChange}
                            className={`${baseInputClasses.replace('h-10', '')} w-full`}
                            placeholder={placeholder}
                            rows="3"
                            required={required}
                            readOnly={readOnly}
                            disabled={readOnly}
                        ></textarea>
                    </div>
                );
            }

            return (
                <div className={wrapperClasses}>
                    <label htmlFor={id} className={labelClasses}>{label}</label>
                    {options ? (
                        <select id={id} name={id} value={value} onChange={onChange} className={combinedInputClasses} required={required} readOnly={readOnly} disabled={readOnly}>
                            <option value="">-- Vyberte --</option>
                            {options.map(option => (
                                <option key={option.value || option} value={option.value || option}>{option.label || option}</option>
                            ))}
                        </select>
                    ) : (
                        <input
                            type={type}
                            id={id}
                            name={id}
                            value={value}
                            onChange={onChange}
                            className={combinedInputClasses}
                            placeholder={placeholder}
                            min={min}
                            step={step}
                            required={required}
                            readOnly={readOnly}
                            disabled={readOnly}
                        />
                    )}
                </div>
            );
        };

        // --- Komponent: common/LabeledCheckbox.js ---
        const LabeledCheckbox = ({ label, id, checked, onChange, readOnly = false }) => (
            <div className="flex items-center">
                <input
                    type="checkbox"
                    id={id}
                    name={id}
                    checked={checked}
                    onChange={onChange}
                    className={`h-4 w-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500 ${readOnly ? 'cursor-not-allowed opacity-60' : ''}`}
                    disabled={readOnly}
                />
                <label htmlFor={id} className={`ml-2 text-sm font-medium text-gray-700 ${readOnly ? 'opacity-60' : ''}`}>{label}</label>
            </div>
        );

        // --- Komponent: common/AxleVisualization.js ---
        const AxleVisualization = ({ numberOfAxles, bandagedWheels, onBandageChange, readOnly = false }) => {
            const axles = Array.from({ length: numberOfAxles }, (_, axleIndex) => {
                const bottomWheelDataIndex = axleIndex * 2;
                const topWheelDataIndex = axleIndex * 2 + 1;

                return (
                    <React.Fragment key={axleIndex}>
                        {axleIndex === numberOfAxles / 2 && numberOfAxles === 4 && (
                            <div className="axle-gap-horizontal"></div>
                        )}
                        <div className="axle-group">
                            <div
                                className={`wheel ${bandagedWheels[topWheelDataIndex] ? 'bandaged' : ''} ${readOnly ? 'cursor-default' : 'cursor-pointer'}`}
                                onClick={() => !readOnly && onBandageChange(topWheelDataIndex)}
                            ></div>
                            <div className="axle-bar"></div>
                            <div
                                className={`wheel ${bandagedWheels[bottomWheelDataIndex] ? 'bandaged' : ''} ${readOnly ? 'cursor-default' : 'cursor-pointer'}`}
                                onClick={() => !readOnly && onBandageChange(bottomWheelDataIndex)}
                            ></div>
                        </div>
                    </React.Fragment>
                );
            });

            return (
                <div className="axle-visualization-container">
                    {axles}
                </div>
            );
        };

        // --- Komponent: common/SignalVisualization.js ---
        const SignalVisualization = ({ signalType, pocetSvetiel, signalKind, isEditMode }) => {
            if (!signalType) return (
                <div className="signal-visualization-container text-gray-500">
                    Vyplňte typ návestidla pre vizualizáciu.
                </div>
            );

            const renderLights = () => {
                const lights = [];
                for (let i = 0; i < pocetSvetiel; i++) {
                    let colorClass = '';
                    if (signalType === 'Svetelné') {
                        if (signalKind === 'Odjazdové' || signalKind === 'Vjazdové' || signalKind === 'Oddielové') {
                            if (pocetSvetiel === 1) colorClass = 'red';
                            else if (pocetSvetiel === 2) {
                                if (i === 0) colorClass = 'red';
                                else if (i === 1) colorClass = 'green';
                            } else if (pocetSvetiel === 3) {
                                if (i === 0) colorClass = 'red';
                                else if (i === 1) colorClass = 'yellow';
                                else if (i === 2) colorClass = 'green';
                            }
                        } else if (signalKind === 'Predzvesť') {
                            if (pocetSvetiel === 1) colorClass = 'yellow';
                            else if (pocetSvetiel === 2) {
                                if (i === 0) colorClass = 'yellow';
                                else if (i === 1) colorClass = 'green';
                            }
                        } else if (signalKind === 'Zoraďovacie') {
                             if (pocetSvetiel === 2) {
                                if (i === 0 || i === 1) colorClass = 'white';
                             }
                        }
                    }
                    lights.push(<div key={i} className={`signal-light ${colorClass}`}></div>);
                }
                return lights;
            };

            return (
                <div className="signal-visualization-container">
                    {signalType === 'Svetelné' && pocetSvetiel > 0 && (
                        <div className="flex flex-col items-center">
                            <div className="signal-light-head">
                                {renderLights()}
                            </div>
                            <div className="signal-post"></div>
                        </div>
                    )}
                    {signalType === 'Mechanické' && (
                        <div className="flex flex-col items-center">
                            <div className={`signal-mechanical-arm ${isEditMode ? 'down' : 'up'}`}></div>
                            <div className="signal-post"></div>
                        </div>
                    )}
                    {(!signalType || (signalType === 'Svetelné' && pocetSvetiel === 0)) && (
                        <div className="text-gray-500">
                            Vyberte platný typ a počet svetiel pre vizualizáciu.
                        </div>
                    )}
                </div>
            );
        };

        // --- Komponent: common/MessageModal.js ---
        const MessageModal = ({ message, onClose }) => {
            if (!message) return null;

            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                        <p className="text-lg font-semibold text-gray-800 mb-4">{message}</p>
                        <button
                            onClick={onClose}
                            className="bg-blue-600 text-white px-5 py-2 rounded-md hover:bg-blue-700 transition duration-200"
                        >
                            Zavrieť
                        </button>
                    </div>
                </div>
            );
        };

        // --- Komponent: layout/Header.js ---
        function Header({ onNavigate, authStatusMessage }) {
            return (
                <header className="bg-white border-b border-blue-100 p-4 shadow-sm">
                    <div className="flex justify-between items-center max-w-7xl mx-auto">
                        <div className="flex items-center">
                            <img src="https://placehold.co/40x40/dbeafe/1e40af?text=LOGO" alt="Logo RailModelRegistry" className="w-10 h-10 rounded-lg mr-3 shadow-sm" />
                            <span className="text-2xl font-bold text-blue-800">RailModelRegistry</span>
                            <span className="ml-6 text-sm text-gray-600 italic">({authStatusMessage})</span>
                        </div>

                        <nav className="flex space-x-6">
                            <a href="#" onClick={() => onNavigate('home')} className="text-blue-700 hover:text-blue-900 font-medium transition duration-200">Domov</a>
                            <a href="#" onClick={() => onNavigate('models')} className="text-blue-700 hover:text-blue-900 font-medium transition duration-200">Modely</a>
                            <a href="#" onClick={() => onNavigate('search')} className="text-blue-700 hover:text-blue-900 font-medium transition duration-200">Hľadať</a>
                            <a href="#" onClick={() => onNavigate('exportCsv')} className="text-blue-700 hover:text-blue-900 font-medium transition duration-200">Export CSV</a>
                            <a href="#" className="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700 transition duration-200 shadow-md">Prihlásenie</a>
                            <a href="#" className="bg-green-600 text-white px-5 py-2.5 rounded-lg hover:bg-green-700 transition duration-200 shadow-md">Registrácia</a>
                        </nav>
                    </div>
                </header>
            );
        }

        // --- Komponent: layout/Sidebar.js ---
        function Sidebar({ onNavigate }) {
            return (
                <aside className="w-64 bg-blue-50 text-blue-800 p-6 h-screen sticky top-0 shadow-md flex flex-col">
                    <h2 className="text-2xl font-bold mb-8">Navigácia</h2>
                    <nav className="flex-grow">
                        <ul>
                            <li className="mb-4">
                                <a href="#" onClick={() => onNavigate('models')} className="block p-3 rounded-lg hover:bg-blue-200 hover:text-blue-900 font-medium transition duration-200">Evidenčné karty</a>
                            </li>
                            <li className="mb-4">
                                <a href="#" onClick={() => onNavigate('ciselnici')} className="block p-3 rounded-lg hover:bg-blue-200 hover:text-blue-900 font-medium transition duration-200">Číselníky</a>
                            </li>
                            <li className="mb-4">
                                <a href="#" onClick={() => onNavigate('print')} className="block p-3 rounded-lg hover:bg-blue-200 hover:text-blue-900 font-medium transition duration-200">Tlač</a>
                            </li>
                            <li>
                                <a href="#" onClick={() => onNavigate('settings')} className="block p-3 rounded-lg hover:bg-blue-200 hover:text-blue-900 font-medium transition duration-200">Nastavenia</a>
                            </li>
                        </ul>
                    </nav>
                    <div className="mt-auto pt-6 border-t border-blue-200 text-base text-blue-600 text-center">
                        <p className="font-semibold">Zephyr</p>
                        <p className="text-sm text-blue-500">© 2025</p>
                    </div>
                </aside>
            );
        }

        // --- Komponent: forms/LokomotivaForm.js ---
        const LokomotivaForm = React.forwardRef(({ initialData, isEditMode, showMessage, allReferenceData }, ref) => {
            const [modelName, setModelName] = useState(initialData?.modelName || '');
            const [type, setType] = useState(initialData?.type || '');
            const [manufacturer, setManufacturer] = useState(initialData?.manufacturer || '');
            const [scale, setScale] = useState(initialData?.scale || '');
            const [imageFile, setImageFile] = useState(null);
            const [imagePreviewUrl, setImagePreviewUrl] = useState(initialData?.imageDataUrl || '');

            const [evidencneCislo, setEvidencneCislo] = useState(initialData?.evidencneCislo || '');
            const [epocha, setEpocha] = useState(initialData?.epocha || '');
            const [sprava, setSprava] = useState(initialData?.sprava || '');
            const [depo, setDepo] = useState(initialData?.depo || '');
            const [stav, setStav] = useState(initialData?.stav || '');
            const [datumZakupeniaModelu, setDatumZakupeniaModelu] = useState(initialData?.datumZakupeniaModelu || '');
            const [cenaModelu, setCenaModelu] = useState(initialData?.cenaModelu || '');
            const [obchodnikModelu, setObchodnikModelu] = useState(initialData?.obchodnikModelu || '');
            const [zarukaModelu, setZarukaModelu] = useState(initialData?.zarukaModelu || '');

            const [dlzkaNarazniky, setDlzkaNarazniky] = useState(initialData?.dlzkaNarazniky || '');
            const [hmotnost, setHmotnost] = useState(initialData?.hmotnost || '');
            const [maxRychlost, setMaxRychlost] = useState(initialData?.maxRychlost || '');
            const [minPolomer, setMinPolomer] = useState(initialData?.minPolomer || '');
            const [typSpriahly, setTypSpriahly] = useState(initialData?.typSpriahly || '');

            const [selectedDecoderId, setSelectedDecoderId] = useState(initialData?.selectedDecoderId || '');
            const [rozhranieDekoder, setRozhranieDekoder] = useState(initialData?.rozhranieDekoder || '');
            const [typDekoder, setTypDekoder] = useState(initialData?.typDekoder || '');
            const [vyrobcaDekoder, setVyrobcaDekoder] = useState(initialData?.vyrobcaDekoder || '');
            const [adresaDekoder, setAdresaDekoder] = useState(initialData?.adresaDekoder || '');
            const [datumZakupeniaDekoder, setDatumZakupeniaDekoder] = useState(initialData?.datumZakupeniaDekoder || '');
            const [cenaDekoder, setCenaDekoder] = useState(initialData?.cenaDekoder || '');
            const [obchodnikDekoder, setObchodnikDekoder] = useState(initialData?.obchodnikDekoder || '');
            const [zarukaDekoder, setZarukaDekoder] = useState(initialData?.zarukaDekoder || '');
            const [cvValue1, setCvValue1] = useState(initialData?.cvValues?.cvValue1 || '');
            const [cvValue2, setCvValue2] = useState(initialData?.cvValues?.cvValue2 || '');
            const [cvValue3, setCvValue3] = useState(initialData?.cvValues?.cvValue3 || '');
            const [cvNotes, setCvNotes] = useState(initialData?.cvNotes || '');

            const [voltageDekoder, setVoltageDekoder] = useState(initialData?.powerConsumption?.voltageDekoder || '');
            const [currentDekoder, setCurrentDekoder] = useState(initialData?.powerConsumption?.currentDekoder || '');

            const [zvuk, setZvuk] = useState(initialData?.funkcie?.zvuk || false);
            const [svetlaSmer, setSvetlaSmer] = useState(initialData?.funkcie?.svetlaSmer || false);
            const [vnutorneOsvetlenie, setVnutorneOsvetlenie] = useState(initialData?.funkcie?.vnutorneOsvetlenie || false);
            const [generatorDymu, setGeneratorDymu] = useState(initialData?.funkcie?.generatorDymu || false);
            const [elektrickeSpriahlo, setElektrickeSpriahlo] = useState(initialData?.funkcie?.elektrickeSpriahlo || false);

            const [pocetNaprav, setPocetNaprav] = useState(initialData?.napravy?.pocetNaprav || 2);
            const [pocetHnanychNaprav, setPocetHnanychNaprav] = useState(initialData?.napravy?.pocetHnanychNaprav || 0);
            const [pocetBandazi, setPocetBandazi] = useState(initialData?.napravy?.pocetBandazi || 0);
            const [bandazeNaKolesach, setBandazeNaKolesach] = useState(initialData?.napravy?.bandazeNaKolesach || new Array(pocetNaprav * 2).fill(false));

            const [isEditingAxles, setIsEditingAxles] = useState(true);

            const [lastServiceDate, setLastServiceDate] = useState(initialData?.serviceHistory?.lastServiceDate || '');
            const [serviceDescription, setServiceDescription] = useState(initialData?.serviceHistory?.serviceDescription || '');
            const [serviceCost, setServiceCost] = useState(initialData?.serviceHistory?.serviceCost || '');
            const [servicedBy, setServicedBy] = useState(initialData?.serviceHistory?.servicedBy || '');

            const [lastModificationDate, setLastModificationDate] = useState(initialData?.modifications?.lastModificationDate || '');
            const [modificationDescription, setModificationDescription] = useState(initialData?.modifications?.modificationDescription || '');
            const [modificationCost, setModificationCost] = useState(initialData?.modifications?.modificationCost || '');

            const [location, setLocation] = useState(initialData?.location || '');
            const [packagingCondition, setPackagingCondition] = useState(initialData?.packagingCondition || '');
            const [conditionRating, setConditionRating] = useState(initialData?.conditionRating || '');
            const [modelAccessories, setModelAccessories] = useState(initialData?.modelAccessories || '');

            const [soundProjectName, setSoundProjectName] = useState(initialData?.soundProject?.name || '');
            const [soundProjectVersion, setSoundProjectVersion] = useState(initialData?.soundProject?.version || '');
            const [soundProjectAuthor, setSoundProjectAuthor] = useState(initialData?.soundProject?.author || '');
            const [soundProjectLink, setSoundProjectLink] = useState(initialData?.soundProject?.link || '');

            const [dccFunctions, setDccFunctions] = useState(initialData?.dccFunctions || '');

            const [lastOperationDate, setLastOperationDate] = useState(initialData?.lastOperation?.date || '');
            const [operatingHours, setOperatingHours] = useState(initialData?.lastOperation?.hours || '');

            const isInternalUpdate = useRef(false);

            // Dynamické možnosti z allReferenceData
            const manufacturerOptions = allReferenceData.manufacturers || [];
            const scaleOptions = allReferenceData.scales || [];
            const epochaOptions = allReferenceData.epochs || [];
            const spravaOptions = allReferenceData.administrations || [];
            const depoOptions = allReferenceData.depots || [];
            const stavOptions = allReferenceData.conditions || [];
            const obchodnikOptions = allReferenceData.dealers || [];
            const typSpriahlyOptions = allReferenceData.couplingTypes || [];
            const rozhranieDekoderOptions = allReferenceData.decoderInterfaces || [];
            const typDekoderOptions = allReferenceData.decoderTypes || [];
            const vyrobcaDekoderOptions = allReferenceData.decoderManufacturers || [];
            const packagingConditionOptions = allReferenceData.packagingConditions || [];
            const conditionRatingOptions = allReferenceData.conditionRatings || [];
            const locomotiveTypeOptions = allReferenceData.locomotiveTypes || [];


            const decoderOptions = [
                { value: 'decoder1', label: 'ESU LokSound 5' },
                { value: 'decoder2', label: 'Zimo MX645' },
                { value: 'decoder3', label: 'Lenz Silver+' },
                { value: 'none', label: 'Žiadny dekodér' },
            ];

            useEffect(() => {
                setModelName(initialData?.modelName || '');
                setType(initialData?.type || '');
                setManufacturer(initialData?.manufacturer || '');
                setScale(initialData?.scale || '');
                setImagePreviewUrl(initialData?.imageDataUrl || '');

                setEvidencneCislo(initialData?.evidencneCislo || '');
                setEpocha(initialData?.epocha || '');
                setSprava(initialData?.sprava || '');
                setDepo(initialData?.depo || '');
                setStav(initialData?.stav || '');
                setDatumZakupeniaModelu(initialData?.datumZakupeniaModelu || '');
                setCenaModelu(initialData?.cenaModelu || '');
                setObchodnikModelu(initialData?.obchodnikModelu || '');
                setZarukaModelu(initialData?.zarukaModelu || '');

                setDlzkaNarazniky(initialData?.dlzkaNarazniky || '');
                setHmotnost(initialData?.hmotnost || '');
                setMaxRychlost(initialData?.maxRychlost || '');
                setMinPolomer(initialData?.minPolomer || '');
                setTypSpriahly(initialData?.typSpriahly || '');

                setSelectedDecoderId(initialData?.selectedDecoderId || '');
                setRozhranieDekoder(initialData?.rozhranieDekoder || '');
                setTypDekoder(initialData?.typDekoder || '');
                setVyrobcaDekoder(initialData?.vyrobcaDekoder || '');
                setAdresaDekoder(initialData?.adresaDekoder || '');
                setDatumZakupeniaDekoder(initialData?.datumZakupeniaDekoder || '');
                setCenaDekoder(initialData?.cenaDekoder || '');
                setObchodnikDekoder(initialData?.obchodnikDekoder || '');
                setZarukaDekoder(initialData?.zarukaDekoder || '');
                setCvValue1(initialData?.cvValues?.cvValue1 || '');
                setCvValue2(initialData?.cvValues?.cvValue2 || '');
                setCvValue3(initialData?.cvValues?.cvValue3 || '');
                setCvNotes(initialData?.cvNotes || '');

                setVoltageDekoder(initialData?.powerConsumption?.voltageDekoder || '');
                setCurrentDekoder(initialData?.powerConsumption?.currentDekoder || '');

                setZvuk(initialData?.funkcie?.zvuk || false);
                setSvetlaSmer(initialData?.funkcie?.svetlaSmer || false);
                setVnutorneOsvetlenie(initialData?.funkcie?.vnutorneOsvetlenie || false);
                setGeneratorDymu(initialData?.funkcie?.generatorDymu || false);
                setElektrickeSpriahlo(initialData?.funkcie?.elektrickeSpriahlo || false);

                setPocetNaprav(initialData?.napravy?.pocetNaprav || 2);
                setPocetHnanychNaprav(initialData?.napravy?.pocetHnanychNaprav || 0);
                setPocetBandazi(initialData?.napravy?.pocetBandazi || 0);
                setBandazeNaKolesach(initialData?.napravy?.bandazeNaKolesach || new Array((initialData?.napravy?.pocetNaprav || 2) * 2).fill(false));
                setImageFile(null);

                setLastServiceDate(initialData?.serviceHistory?.lastServiceDate || '');
                setServiceDescription(initialData?.serviceHistory?.serviceDescription || '');
                setServiceCost(initialData?.serviceHistory?.serviceCost || '');
                setServicedBy(initialData?.serviceHistory?.servicedBy || '');

                setLastModificationDate(initialData?.modifications?.lastModificationDate || '');
                setModificationDescription(initialData?.modifications?.modificationDescription || '');
                setModificationCost(initialData?.modifications?.modificationCost || '');

                setLocation(initialData?.location || '');
                setPackagingCondition(initialData?.packagingCondition || '');
                setConditionRating(initialData?.conditionRating || '');
                setModelAccessories(initialData?.modelAccessories || '');

                setSoundProjectName(initialData?.soundProject?.name || '');
                setSoundProjectVersion(initialData?.soundProject?.version || '');
                setSoundProjectAuthor(initialData?.soundProject?.author || '');
                setSoundProjectLink(initialData?.soundProject?.link || '');

                setDccFunctions(initialData?.dccFunctions || '');

                setLastOperationDate(initialData?.lastOperation?.date || '');
                setOperatingHours(initialData?.lastOperation?.hours || '');

            }, [initialData]);

            useEffect(() => {
                const initialBandages = new Array(pocetNaprav * 2).fill(false);
                setBandazeNaKolesach(initialBandages);
                setPocetBandazi(initialBandages.filter(Boolean).length);
            }, [pocetNaprav]);

            useEffect(() => {
                if (isInternalUpdate.current) {
                    isInternalUpdate.current = false;
                    return;
                }
                isInternalUpdate.current = true;
                setZvuk(typDekoder === 'Zvukový');
            }, [typDekoder]);

            useEffect(() => {
                if (isInternalUpdate.current) {
                    isInternalUpdate.current = false;
                    return;
                }
                isInternalUpdate.current = true;
                if (zvuk) {
                    setTypDekoder('Zvukový');
                } else {
                    setTypDekoder('');
                }
            }, [zvuk]);

            const handleBandazChange = (index) => {
                if (!isEditMode) return;
                const newBandaze = [...bandazeNaKolesach];
                newBandaze[index] = !newBandaze[index];
                setBandazeNaKolesach(newBandaze);
                setPocetBandazi(newBandaze.filter(Boolean).length);
            };

            const handleImageChange = (file) => {
                if (!isEditMode) return;
                if (file) {
                    setImageFile(file);
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setImagePreviewUrl(reader.result);
                    };
                    reader.readAsDataURL(file);
                } else {
                    setImageFile(null);
                    setImagePreviewUrl('');
                }
            };

            const getCurrentFormData = () => ({
                modelName, type, category: 'Lokomotíva', manufacturer, scale,
                imageFileName: imageFile ? imageFile.name : (initialData?.imageFileName || null),
                imageDataUrl: imagePreviewUrl,
                evidencneCislo, epocha, sprava, depo, stav,
                datumZakupeniaModelu, cenaModelu, obchodnikModelu, zarukaModelu,
                dlzkaNarazniky, hmotnost, maxRychlost, minPolomer, typSpriahly,
                selectedDecoderId,
                rozhranieDekoder, typDekoder, vyrobcaDekoder, adresaDekoder,
                datumZakupeniaDekoder, cenaDekoder, obchodnikDekoder, zarukaDekoder,
                cvValues: { cvValue1, cvValue2, cvValue3 },
                cvNotes,
                powerConsumption: { voltageDekoder, currentDekoder },
                funkcie: { zvuk, svetlaSmer, vnutorneOsvetlenie, generatorDymu, elektrickeSpriahlo },
                napravy: { pocetNaprav, pocetHnanychNaprav, pocetBandazi, bandazeNaKolesach },
                serviceHistory: { lastServiceDate, serviceDescription, serviceCost, servicedBy },
                modifications: { lastModificationDate, modificationDescription, modificationCost },
                location,
                packagingCondition,
                conditionRating,
                modelAccessories,
                soundProject: { name: soundProjectName, version: soundProjectVersion, author: soundProjectAuthor, link: soundProjectLink },
                dccFunctions,
                lastOperation: { date: lastOperationDate, hours: operatingHours }
            });

            useImperativeHandle(ref, () => ({
                getCurrentFormData,
            }));

            return (
                <div className="bg-white p-8 rounded-xl shadow-lg border border-blue-100">
                    <h1 className="text-3xl font-bold text-blue-800 mb-6">{isEditMode ? (initialData ? 'Upraviť lokomotívu' : 'Pridať novú lokomotívu') : 'Detail lokomotívy'}</h1>
                        <div className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200 mb-6">
                            <h2 className="text-xl font-semibold text-blue-700 mb-4">Základné údaje</h2>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div className="md:col-span-1 md:row-span-full flex flex-col items-center justify-start p-4 border border-gray-300 rounded-md bg-white min-h-[250px] relative">
                                    <div className="image-preview-container">
                                        {imagePreviewUrl ? (
                                            <img src={imagePreviewUrl} alt="Náhľad obrázka" className="max-w-full max-h-full object-contain" />
                                        ) : (
                                            <div className="image-preview-placeholder">
                                                Žiadny obrázok k dispozícii
                                            </div>
                                        )}
                                    </div>
                                    <div className="w-full px-2 mt-4">
                                        <LabeledInput label="Nahrať obrázok" id="image" type="file" onChange={handleImageChange} readOnly={!isEditMode} />
                                    </div>
                                </div>

                                <div className="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-3">
                                    <LabeledInput label="Názov modelu" id="modelName" value={modelName} onChange={(e) => setModelName(e.target.value)} placeholder="Parná lokomotíva 475.1" required readOnly={!isEditMode} />
                                    <LabeledInput label="Ev. číslo" id="evidencneCislo" value={evidencneCislo} onChange={(e) => setEvidencneCislo(e.target.value)} placeholder="475.175" readOnly={!isEditMode} />
                                    <LabeledInput label="Typ" id="type" type="select" value={type} onChange={(e) => setType(e.target.value)} options={locomotiveTypeOptions} required readOnly={!isEditMode} />
                                    <LabeledInput label="Výrobca" id="manufacturer" type="select" value={manufacturer} onChange={(e) => setManufacturer(e.target.value)} options={manufacturerOptions} required readOnly={!isEditMode} />
                                    <LabeledInput label="Mierka" id="scale" type="select" value={scale} onChange={(e) => setScale(e.target.value)} options={scaleOptions} required readOnly={!isEditMode} />
                                    <LabeledInput label="Epocha" id="epocha" type="select" value={epocha} onChange={(e) => setEpocha(e.target.value)} options={epochaOptions} readOnly={!isEditMode} />
                                    <LabeledInput label="Správa" id="sprava" type="select" value={sprava} onChange={(e) => setSprava(e.target.value)} options={spravaOptions} readOnly={!isEditMode} />
                                    <LabeledInput label="Depo" id="depo" value={depo} onChange={(e) => setDepo(e.target.value)} placeholder="Praha" readOnly={!isEditMode} options={depoOptions} />
                                    <LabeledInput label="Stav" id="stav" type="select" value={stav} onChange={(e) => setStav(e.target.value)} options={stavOptions} readOnly={!isEditMode} />
                                    <LabeledInput label="Dátum zak." id="datumZakupeniaModelu" type="date" value={datumZakupeniaModelu} onChange={(e) => setDatumZakupeniaModelu(e.target.value)} readOnly={!isEditMode} />
                                    <LabeledInput label="Cena" id="cenaModelu" type="number" value={cenaModelu} onChange={(e) => setCenaModelu(e.target.value)} placeholder="250.00" step="0.01" readOnly={!isEditMode} />
                                    <LabeledInput label="Obchodník" id="obchodnikModelu" type="select" value={obchodnikModelu} onChange={(e) => setObchodnikModelu(e.target.value)} options={obchodnikOptions} readOnly={!isEditMode} />
                                    <LabeledInput label="Záruka do" id="zarukaModelu" type="date" value={zarukaModelu} onChange={(e) => setZarukaModelu(e.target.value)} readOnly={!isEditMode} />
                                    <LabeledInput label="Umiestnenie" id="location" value={location} onChange={(e) => setLocation(e.target.value)} placeholder="vitrína A" readOnly={!isEditMode} />
                                    <LabeledInput label="Stav obalu" id="packagingCondition" type="select" value={packagingCondition} onChange={(e) => setPackagingCondition(e.target.value)} options={packagingConditionOptions} readOnly={!isEditMode} />
                                    <LabeledInput label="Hodnotenie stavu" id="conditionRating" type="select" value={conditionRating} onChange={(e) => setConditionRating(e.target.value)} options={conditionRatingOptions} readOnly={!isEditMode} />
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">

                            <div className="flex flex-col gap-6">
                                <div className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200">
                                    <h2 className="text-xl font-semibold text-blue-700 mb-2">Technické údaje</h2>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-3">
                                        <LabeledInput label="Dĺžka (mm)" id="dlzkaNarazniky" type="number" value={dlzkaNarazniky} onChange={(e) => setDlzkaNarazniky(e.target.value)} placeholder="210" readOnly={!isEditMode} />
                                        <LabeledInput label="Hmotnosť (t)" id="hmotnost" type="number" value={hmotnost} onChange={(e) => setHmotnost(e.target.value)} placeholder="0.45" step="0.01" readOnly={!isEditMode} />
                                        <LabeledInput label="Max. rýchlosť (km/h)" id="maxRychlost" type="number" value={maxRychlost} onChange={(e) => setMaxRychlost(e.target.value)} placeholder="120" readOnly={!isEditMode} />
                                        <LabeledInput label="Min. polomer (mm)" id="minPolomer" type="number" value={minPolomer} onChange={(e) => setMinPolomer(e.target.value)} placeholder="360" readOnly={!isEditMode} />
                                        <LabeledInput label="Typ spriahly" id="typSpriahly" type="select" value={typSpriahly} onChange={(e) => setTypSpriahly(e.target.value)} options={typSpriahlyOptions} readOnly={!isEditMode} />
                                    </div>
                                </div>

                                <div className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200 flex flex-col gap-2">
                                    <h2 className="text-xl font-semibold text-blue-700 mb-2">Funkcie</h2>
                                    <LabeledCheckbox label="Zvuk" id="zvuk" checked={zvuk} onChange={(e) => {
                                        if (!isEditMode) return;
                                        isInternalUpdate.current = false;
                                        setZvuk(e.target.checked);
                                    }} readOnly={!isEditMode} />
                                    <LabeledCheckbox label="Svetlá podľa smeru" id="svetlaSmer" checked={svetlaSmer} onChange={(e) => setSvetlaSmer(e.target.checked)} readOnly={!isEditMode} />
                                    <LabeledCheckbox label="Vnútorné osvetlenie" id="vnutorneOsvetlenie" checked={vnutorneOsvetlenie} onChange={(e) => setVnutorneOsvetlenie(e.target.checked)} readOnly={!isEditMode} />
                                    <LabeledCheckbox label="Generátor dymu" id="generatorDymu" checked={generatorDymu} onChange={(e) => setGeneratorDymu(e.target.checked)} readOnly={!isEditMode} />
                                    <LabeledCheckbox label="Elektrické spriahlo" id="elektrickeSpriahlo" checked={elektrickeSpriahlo} onChange={(e) => setElektrickeSpriahlo(e.target.checked)} readOnly={!isEditMode} />
                                </div>

                                <div className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200">
                                    <h2 className="text-xl font-semibold text-blue-700 mb-4">Servis a údržba</h2>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-3">
                                        <LabeledInput label="Dátum posledného servisu" id="lastServiceDate" type="date" value={lastServiceDate} onChange={(e) => setLastServiceDate(e.target.value)} readOnly={!isEditMode} />
                                        <LabeledInput label="Náklady na servis (€)" id="serviceCost" type="number" value={serviceCost} onChange={(e) => setServiceCost(e.target.value)} placeholder="0.00" step="0.01" readOnly={!isEditMode} />
                                        <LabeledInput label="Servis vykonal" id="servicedBy" type="text" value={servicedBy} onChange={(e) => setServicedBy(e.target.value)} placeholder="Meno / Firma" readOnly={!isEditMode} />
                                        <LabeledInput label="Popis vykonaných prác" id="serviceDescription" type="textarea" value={serviceDescription} onChange={(e) => setServiceDescription(e.target.value)} placeholder="Popis čistenia, mazania, výmeny súčiastok..." readOnly={!isEditMode} spanFull={true} />
                                    </div>
                                </div>

                                <div className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200">
                                    <h2 className="text-xl font-semibold text-blue-700 mb-4">Modifikácie a úpravy</h2>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-3">
                                        <LabeledInput label="Dátum modifikácie" id="lastModificationDate" type="date" value={lastModificationDate} onChange={(e) => setLastModificationDate(e.target.value)} readOnly={!isEditMode} />
                                        <LabeledInput label="Náklady na modifikáciu (€)" id="modificationCost" type="number" value={modificationCost} onChange={(e) => setModificationCost(e.target.value)} placeholder="0.00" step="0.01" readOnly={!isEditMode} />
                                        <LabeledInput label="Popis vykonanej úpravy" id="modificationDescription" type="textarea" value={modificationDescription} onChange={(e) => setModificationDescription(e.target.value)} placeholder="Digitálne spriahlo, osvetlenie, patinovanie, zmena zvuku..." readOnly={!isEditMode} spanFull={true} />
                                </div>
                                </div>

                                <div className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200">
                                    <h2 className="text-xl font-semibold text-blue-700 mb-4">Príslušenstvo k modelu</h2>
                                    <LabeledInput label="Zoznam príslušenstva" id="modelAccessories" type="textarea" value={modelAccessories} onChange={(e) => setModelAccessories(e.target.value)} placeholder="Náhradné diely, spriahla, doplnky, originálne balenie..." readOnly={!isEditMode} spanFull={true} />
                                </div>
                            </div>

                            <div className="flex flex-col gap-6">
                                <div className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200">
                                    <h2 className="text-xl font-semibold text-blue-700 mb-4">Dekodér</h2>
                                    <LabeledInput
                                        label="Vyberte dekodér"
                                        id="selectedDecoderId"
                                        type="select"
                                        value={selectedDecoderId}
                                        onChange={(e) => setSelectedDecoderId(e.target.value)}
                                        options={decoderOptions}
                                        readOnly={!isEditMode}
                                    />
                                    {selectedDecoderId && selectedDecoderId !== 'none' && (
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-3 mt-4">
                                            <LabeledInput label="Rozhranie" id="rozhranieDekoder" type="select" value={rozhranieDekoder} onChange={(e) => setRozhranieDekoder(e.target.value)} options={rozhranieDekoderOptions} readOnly={!isEditMode} />
                                            <LabeledInput label="Typ" id="typDekoder" type="select" value={typDekoder} onChange={(e) => {
                                                if (!isEditMode) return;
                                                isInternalUpdate.current = false;
                                                setTypDekoder(e.target.value);
                                            }} options={typDekoderOptions} readOnly={!isEditMode} />
                                            <LabeledInput label="Výrobca" id="vyrobcaDekoder" type="select" value={vyrobcaDekoder} onChange={(e) => setVyrobcaDekoder(e.target.value)} options={vyrobcaDekoderOptions} readOnly={!isEditMode} />
                                            <LabeledInput label="Adresa" id="adresaDekoder" value={adresaDekoder} onChange={(e) => setAdresaDekoder(e.target.value)} placeholder="3" readOnly={!isEditMode} />
                                            <LabeledInput label="CV1 (Adresa)" id="cvValue1" type="number" value={cvValue1} onChange={(e) => setCvValue1(e.target.value)} placeholder="3" readOnly={!isEditMode} />
                                            <LabeledInput label="CV2 (Min. rýchlosť)" id="cvValue2" type="number" value={cvValue2} onChange={(e) => setCvValue2(e.target.value)} placeholder="2" readOnly={!isEditMode} />
                                            <LabeledInput label="Dátum zak." id="datumZakupeniaDekoder" type="date" value={datumZakupeniaDekoder} onChange={(e) => setDatumZakupeniaDekoder(e.target.value)} readOnly={!isEditMode} />
                                            <LabeledInput label="Cena" id="cenaDekoder" type="number" value={cenaDekoder} onChange={(e) => setCenaDekoder(e.target.value)} placeholder="50.00" step="0.01" readOnly={!isEditMode} />
                                            <LabeledInput label="Obchodník" id="obchodnikDekoder" type="select" value={obchodnikDekoder} onChange={(e) => setObchodnikDekoder(e.target.value)} options={obchodnikOptions} readOnly={!isEditMode} />
                                            <LabeledInput label="Záruka do" id="zarukaDekoder" type="date" value={zarukaDekoder} onChange={(e) => setZarukaDekoder(e.target.value)} readOnly={!isEditMode} />
                                            <LabeledInput label="CV3 (Zrýchlenie)" id="cvValue3" type="number" value={cvValue3} onChange={(e) => setCvValue3(e.target.value)} placeholder="10" readOnly={!isEditMode} />
                                            <LabeledInput label="Poznámky k CV:" id="cvNotes" type="textarea" value={cvNotes} onChange={(e) => setCvNotes(e.target.value)} placeholder="Špecifické nastavenia, zvukové funkcie..." readOnly={!isEditMode} spanFull={true} />

                                            <h3 className="text-lg font-semibold text-blue-600 mt-4 col-span-full">Spotreba energie</h3>
                                            <LabeledInput label="Napätie (V)" id="voltageDekoder" type="number" value={voltageDekoder} onChange={(e) => setVoltageDekoder(e.target.value)} placeholder="12" step="0.1" readOnly={!isEditMode} />
                                            <LabeledInput label="Prúd (mA)" id="currentDekoder" type="number" value={currentDekoder} onChange={(e) => setCurrentDekoder(e.target.value)} placeholder="100" step="1" readOnly={!isEditMode} />

                                            {typDekoder === 'Zvukový' && (
                                                <>
                                                    <h3 className="text-lg font-semibold text-blue-600 mt-4 col-span-full">Zvukový projekt</h3>
                                                    <LabeledInput label="Názov projektu" id="soundProjectName" value={soundProjectName} onChange={(e) => setSoundProjectName(e.target.value)} placeholder="Parná lokomotíva 475.1 zvuk" readOnly={!isEditMode} />
                                                    <LabeledInput label="Verzia projektu" id="soundProjectVersion" value={soundProjectVersion} onChange={(e) => setSoundProjectVersion(e.target.value)} placeholder="1.0" readOnly={!isEditMode} />
                                                    <LabeledInput label="Autor projektu" id="soundProjectAuthor" value={soundProjectAuthor} onChange={(e) => setSoundProjectAuthor(e.target.value)} placeholder="Janko Mrkvička" readOnly={!isEditMode} />
                                                    <LabeledInput label="Odkaz na súbor projektu" id="soundProjectLink" type="url" value={soundProjectLink} onChange={(e) => setSoundProjectLink(e.target.value)} placeholder="https://mojeprojekty.sk/475_1.zpp" readOnly={!isEditMode} spanFull={true} />
                                                </>
                                            )}

                                            <h3 className="text-lg font-semibold text-blue-600 mt-4 col-span-full">DCC funkcie (F0-F28)</h3>
                                            <LabeledInput label="Popis funkcií" id="dccFunctions" type="textarea" value={dccFunctions} onChange={(e) => setDccFunctions(e.target.value)} placeholder="F0: Svetlá, F1: Píšťala, F2: Rozjazd..." readOnly={!isEditMode} spanFull={true} />
                                        </div>
                                    )}
                                </div>

                                <div className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200 flex flex-col gap-3">
                                    <h2 className="text-xl font-semibold text-blue-700 mb-2">Nápravy</h2>

                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 w-full items-start">
                                        <div className="flex flex-col gap-3 w-full">
                                            <LabeledInput
                                                label="Počet náprav"
                                                id="pocetNaprav"
                                                type="select"
                                                value={pocetNaprav}
                                                onChange={(e) => setPocetNaprav(parseInt(e.target.value) || 0)}
                                                options={[{value: 2, label: "2 nápravy"}, {value: 4, label: "4 nápravy"}]} // Keep hardcoded for now, as it's a fixed visualization
                                                className="input-short"
                                                readOnly={!isEditMode}
                                            />
                                            <LabeledInput
                                                label="Počet hnaných náprav"
                                                id="pocetHnanychNaprav"
                                                type="number"
                                                value={pocetHnanychNaprav}
                                                onChange={(e) => setPocetHnanychNaprav(parseInt(e.target.value) || 0)}
                                                min="0"
                                                className="input-short"
                                                readOnly={!isEditMode}
                                            />
                                            <LabeledInput
                                                label="Počet bandaží"
                                                id="pocetBandazi"
                                                type="number"
                                                value={pocetBandazi}
                                                readOnly={true}
                                                className="input-short"
                                            />
                                        </div>

                                        {pocetNaprav > 0 && (
                                            <div className="flex flex-col items-center justify-start h-full">
                                                <div className="arrow-text-container">
                                                    <div className="arrow-indicator"></div>
                                                    <span>Čelo lokomotívy</span>
                                                </div>
                                                <AxleVisualization
                                                    numberOfAxles={pocetNaprav}
                                                    bandagedWheels={bandazeNaKolesach}
                                                    onBandageChange={handleBandazChange}
                                                    readOnly={!isEditMode}
                                                />
                                                {pocetBandazi > 0 && (
                                                    <p className="text-sm text-gray-600 mt-2 bandage-info-text">Bandáže sú vyznačené červene.</p>
                                                )}
                                            </div>
                                        )}

                                        {pocetNaprav > 0 && (
                                            <div className="relative w-full h-full flex flex-col items-end justify-between">
                                                {isEditingAxles && (
                                                    <div className="wheel-checkboxes-container">
                                                        <p className="text-sm font-semibold text-gray-700 mb-1">Bandáže:</p>
                                                        <div className="wheel-checkboxes">
                                                            {bandazeNaKolesach.map((hasBandage, index) => {
                                                                let displayLabel = index + 1;
                                                                return (
                                                                    <div key={index} className="wheel-checkbox-item">
                                                                        <input
                                                                            type="checkbox"
                                                                            id={`bandaz-visual-${index}`}
                                                                            checked={hasBandage}
                                                                            onChange={() => handleBandazChange(index)}
                                                                            className="h-4 w-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                                                                            disabled={!isEditMode}
                                                                        />
                                                                        <label htmlFor={`bandaz-visual-${index}`} className={`text-xs text-gray-700 ${!isEditMode ? 'opacity-60' : ''}`}>{displayLabel}</label>
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    </div>
                                                )}
                                                <div className="w-full flex justify-end mt-auto">
                                                    <button
                                                        type="button"
                                                        onClick={() => setIsEditingAxles(!isEditingAxles)}
                                                        className="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition duration-200 text-sm"
                                                        disabled={!isEditMode}
                                                    >
                                                        {isEditingAxles ? 'Skryť bandáže' : 'Zobraziť bandáže'}
                                                    </button>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                <div className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200">
                                    <h2 className="text-xl font-semibold text-blue-700 mb-4">Posledná jazda / Prevádzkové hodiny</h2>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-3">
                                        <LabeledInput label="Dátum poslednej prevádzky" id="lastOperationDate" type="date" value={lastOperationDate} onChange={(e) => setLastOperationDate(e.target.value)} readOnly={!isEditMode} />
                                        <LabeledInput label="Prevádzkové hodiny" id="operatingHours" type="number" value={operatingHours} onChange={(e) => setOperatingHours(e.target.value)} placeholder="0" min="0" readOnly={!isEditMode} />
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>
            );
        });

        // --- Komponent: forms/VagonForm.js ---
        const VagonForm = React.forwardRef(({ initialData, isEditMode, showMessage, allReferenceData }, ref) => {
            const [modelName, setModelName] = useState(initialData?.modelName || '');
            const [evidencneCislo, setEvidencneCislo] = useState(initialData?.evidencneCislo || '');
            const [typeVagonu, setTypeVagonu] = useState(initialData?.typeVagonu || '');
            const [manufacturer, setManufacturer] = useState(initialData?.manufacturer || '');
            const [scale, setScale] = useState(initialData?.scale || '');
            const [epocha, setEpocha] = useState(initialData?.epocha || '');
            const [sprava, setSprava] = useState(initialData?.sprava || '');
            const [depo, setDepo] = useState(initialData?.depo || '');
            const [stav, setStav] = useState(initialData?.stav || '');
            const [datumZakupeniaModelu, setDatumZakupeniaModelu] = useState(initialData?.datumZakupeniaModelu || '');
            const [cenaModelu, setCenaModelu] = useState(initialData?.cenaModelu || '');
            const [obchodnikModelu, setObchodnikModelu] = useState(initialData?.obchodnikModelu || '');
            const [zarukaModelu, setZarukaModelu] = useState(initialData?.zarukaModelu || '');
            const [imageFile, setImageFile] = useState(null);
            const [imagePreviewUrl, setImagePreviewUrl] = useState(initialData?.imageDataUrl || '');

            const [dlzkaNarazniky, setDlzkaNarazniky] = useState(initialData?.dlzkaNarazniky || '');
            const [hmotnost, setHmotnost] = useState(initialData?.hmotnost || '');
            const [pocetNaprav, setPocetNaprav] = useState(initialData?.pocetNaprav || 2);
            const [typSpriahly, setTypSpriahly] = useState(initialData?.typSpriahly || '');
            const [typNakladu, setTypNakladu] = useState(initialData?.typNakladu || '');
            const [farba, setFarba] = useState(initialData?.farba || '');
            const [popis, setPopis] = useState(initialData?.popis || '');

            const [selectedDecoderIdVagon, setSelectedDecoderIdVagon] = useState(initialData?.selectedDecoderIdVagon || '');
            const [rozhranieDekoderVagon, setRozhranieDekoderVagon] = useState(initialData?.rozhranieDekoderVagon || '');
            const [typDekoderVagon, setTypDekoderVagon] = useState(initialData?.typDekoderVagon || '');
            const [vyrobcaDekoderVagon, setVyrobcaDekoderVagon] = useState(initialData?.vyrobcaDekoderVagon || '');
            const [adresaDekoderVagon, setAdresaDekoderVagon] = useState(initialData?.adresaDekoderVagon || '');
            const [datumZakupeniaDekoderVagon, setDatumZakupeniaDekoderVagon] = useState(initialData?.datumZakupeniaDekoderVagon || '');
            const [cenaDekoderVagon, setCenaDekoderVagon] = useState(initialData?.cenaDekoderVagon || '');
            const [obchodnikDekoderVagon, setObchodnikDekoderVagon] = useState(initialData?.obchodnikDekoderVagon || '');
            const [zarukaDekoderVagon, setZarukaDekoderVagon] = useState(initialData?.zarukaDekoderVagon || '');
            const [cvNotesVagon, setCvNotesVagon] = useState(initialData?.cvNotesVagon || '');

            const [voltageDekoderVagon, setVoltageDekoderVagon] = useState(initialData?.powerConsumptionVagon?.voltageDekoderVagon || '');
            const [currentDekoderVagon, setCurrentDekoderVagon] = useState(initialData?.powerConsumptionVagon?.currentDekoderVagon || '');

            const [lastServiceDateVagon, setLastServiceDateVagon] = useState(initialData?.serviceHistoryVagon?.lastServiceDateVagon || '');
            const [serviceDescriptionVagon, setServiceDescriptionVagon] = useState(initialData?.serviceHistoryVagon?.serviceDescriptionVagon || '');
            const [serviceCostVagon, setServiceCostVagon] = useState(initialData?.serviceHistoryVagon?.serviceCostVagon || '');
            const [servicedByVagon, setServicedByVagon] = useState(initialData?.serviceHistoryVagon?.servicedByVagon || '');

            const [lastModificationDateVagon, setLastModificationDateVagon] = useState(initialData?.modificationsVagon?.lastModificationDateVagon || '');
            const [modificationDescriptionVagon, setModificationDescriptionVagon] = useState(initialData?.modificationsVagon?.modificationDescriptionVagon || '');
            const [modificationCostVagon, setModificationCostVagon] = useState(initialData?.modificationsVagon?.modificationCostVagon || '');

            const [location, setLocation] = useState(initialData?.location || '');
            const [packagingCondition, setPackagingCondition] = useState(initialData?.packagingCondition || '');
            const [conditionRating, setConditionRating] = useState(initialData?.conditionRating || '');
            const [modelAccessories, setModelAccessories] = useState(initialData?.modelAccessories || '');

            const [dccFunctionsVagon, setDccFunctionsVagon] = useState(initialData?.dccFunctionsVagon || '');

            const [lastOperationDateVagon, setLastOperationDateVagon] = useState(initialData?.lastOperationVagon?.date || '');
            const [operatingHoursVagon, setOperatingHoursVagon] = useState(initialData?.lastOperationVagon?.hours || '');

            // Dynamické možnosti z allReferenceData
            const manufacturerOptions = allReferenceData.manufacturers || [];
            const scaleOptions = allReferenceData.scales || [];
            const epochaOptions = allReferenceData.epochs || [];
            const spravaOptions = allReferenceData.administrations || [];
            const depoOptions = allReferenceData.depots || [];
            const stavOptions = allReferenceData.conditions || [];
            const obchodnikOptions = allReferenceData.dealers || [];
            const typSpriahlyOptions = allReferenceData.couplingTypes || [];
            const typNakladuOptions = allReferenceData.loadTypes || [];
            const farbaOptions = allReferenceData.colors || [];
            const rozhranieDekoderOptions = allReferenceData.decoderInterfaces || [];
            const typDekoderOptions = allReferenceData.decoderTypes || [];
            const vyrobcaDekoderOptions = allReferenceData.decoderManufacturers || [];
            const wagonTypeOptions = allReferenceData.wagonTypes || [];
            const packagingConditionOptions = allReferenceData.packagingConditions || [];
            const conditionRatingOptions = allReferenceData.conditionRatings || [];

            const decoderOptionsVagon = [
                { value: 'decoderA', label: 'Dekodér A' },
                { value: 'decoderB', label: 'Dekodér B' },
                { value: 'none', label: 'Žiadny dekodér' },
            ];

            useEffect(() => {
                setModelName(initialData?.modelName || '');
                setEvidencneCislo(initialData?.evidencneCislo || '');
                setTypeVagonu(initialData?.typeVagonu || '');
                setManufacturer(initialData?.manufacturer || '');
                setScale(initialData?.scale || '');
                setEpocha(initialData?.epocha || '');
                setSprava(initialData?.sprava || '');
                setDepo(initialData?.depo || '');
                setStav(initialData?.stav || '');
                setDatumZakupeniaModelu(initialData?.datumZakupeniaModelu || '');
                setCenaModelu(initialData?.cenaModelu || '');
                setObchodnikModelu(initialData?.obchodnikModelu || '');
                setZarukaModelu(initialData?.zarukaModelu || '');
                setImagePreviewUrl(initialData?.imageDataUrl || '');
                setImageFile(null);

                setDlzkaNarazniky(initialData?.dlzkaNarazniky || '');
                setHmotnost(initialData?.hmotnost || '');
                setPocetNaprav(initialData?.pocetNaprav || 2);
                setTypSpriahly(initialData?.typSpriahly || '');
                setTypNakladu(initialData?.typNakladu || '');
                setFarba(initialData?.farba || '');
                setPopis(initialData?.popis || '');

                setSelectedDecoderIdVagon(initialData?.selectedDecoderIdVagon || '');
                setRozhranieDekoderVagon(initialData?.rozhranieDekoderVagon || '');
                setTypDekoderVagon(initialData?.typDekoderVagon || '');
                setVyrobcaDekoderVagon(initialData?.vyrobcaDekoderVagon || '');
                setAdresaDekoderVagon(initialData?.adresaDekoderVagon || '');
                setDatumZakupeniaDekoderVagon(initialData?.datumZakupeniaDekoderVagon || '');
                setCenaDekoderVagon(initialData?.cenaDekoderVagon || '');
                setObchodnikDekoderVagon(initialData?.obchodnikDekoderVagon || '');
                setZarukaDekoderVagon(initialData?.zarukaDekoderVagon || '');
                setCvNotesVagon(initialData?.cvNotesVagon || '');

                setVoltageDekoderVagon(initialData?.powerConsumptionVagon?.voltageDekoderVagon || '');
                setCurrentDekoderVagon(initialData?.powerConsumptionVagon?.currentDekoderVagon || '');

                setLastServiceDateVagon(initialData?.serviceHistoryVagon?.lastServiceDateVagon || '');
                setServiceDescriptionVagon(initialData?.serviceHistoryVagon?.serviceDescriptionVagon || '');
                setServiceCostVagon(initialData?.serviceHistoryVagon?.serviceCostVagon || '');
                setServicedByVagon(initialData?.serviceHistoryVagon?.servicedByVagon || '');

                setLastModificationDateVagon(initialData?.modificationsVagon?.lastModificationDateVagon || '');
                setModificationDescriptionVagon(initialData?.modificationsVagon?.modificationDescriptionVagon || '');
                setModificationCostVagon(initialData?.modificationsVagon?.modificationCostVagon || '');

                setLocation(initialData?.location || '');
                setPackagingCondition(initialData?.packagingCondition || '');
                setConditionRating(initialData?.conditionRating || '');
                setModelAccessories(initialData?.modelAccessories || '');

                setDccFunctionsVagon(initialData?.dccFunctionsVagon || '');

                setLastOperationDateVagon(initialData?.lastOperationVagon?.date || '');
                setOperatingHoursVagon(initialData?.lastOperationVagon?.hours || '');

            }, [initialData]);

            const handleImageChange = (file) => {
                if (!isEditMode) return;
                if (file) {
                    setImageFile(file);
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setImagePreviewUrl(reader.result);
                    };
                    reader.readAsDataURL(file);
                } else {
                    setImageFile(null);
                    setImagePreviewUrl('');
                }
            };

            useImperativeHandle(ref, () => ({
                getCurrentFormData: () => ({
                    modelName, evidencneCislo, category: 'Vagón', typeVagonu, manufacturer, scale, epocha, sprava, depo, stav,
                    datumZakupeniaModelu, cenaModelu, obchodnikModelu, zarukaModelu,
                    imageFileName: imageFile ? imageFile.name : (initialData?.imageFileName || null),
                    imageDataUrl: imagePreviewUrl,
                    dlzkaNarazniky, hmotnost, pocetNaprav, typSpriahly, typNakladu, farba, popis,
                    selectedDecoderIdVagon,
                    rozhranieDekoderVagon, typDekoderVagon, vyrobcaDekoderVagon, adresaDekoderVagon,
                    datumZakupeniaDekoderVagon, cenaDekoderVagon, obchodnikDekoderVagon, zarukaDekoderVagon,
                    cvNotesVagon,
                    powerConsumptionVagon: { voltageDekoderVagon, currentDekoderVagon },
                    serviceHistoryVagon: { lastServiceDateVagon, serviceDescriptionVagon, serviceCostVagon, servicedByVagon },
                    modificationsVagon: { lastModificationDateVagon, modificationDescriptionVagon, modificationCostVagon },
                    location,
                    packagingCondition,
                    conditionRating,
                    modelAccessories,
                    dccFunctionsVagon,
                    lastOperationVagon: { date: lastOperationDateVagon, hours: operatingHoursVagon }
                }),
            }));

            return (
                <div className="bg-white p-8 rounded-xl shadow-lg border border-blue-100">
                    <h1 className="text-3xl font-bold text-blue-800 mb-6">{isEditMode ? (initialData ? 'Upraviť vagón' : 'Pridať nový vagón') : 'Detail vagónu'}</h1>

                    <div className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200 mb-6">
                        <h2 className="text-xl font-semibold text-blue-700 mb-4">Základné údaje</h2>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div className="md:col-span-1 md:row-span-full flex flex-col items-center justify-start p-4 border border-gray-300 rounded-md bg-white min-h-[250px] relative">
                                <div className="image-preview-container">
                                    {imagePreviewUrl ? (
                                        <img src={imagePreviewUrl} alt="Náhľad obrázka" className="max-w-full max-h-full object-contain" />
                                    ) : (
                                        <div className="image-preview-placeholder">
                                            Žiadny obrázok k dispozícii
                                        </div>
                                    )}
                                </div>
                                <div className="w-full px-2 mt-4">
                                    <LabeledInput label="Nahrať obrázok" id="imageVagon" type="file" onChange={handleImageChange} readOnly={!isEditMode} />
                                </div>
                            </div>

                            <div className="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-3">
                                <LabeledInput label="Názov modelu" id="modelNameVagon" value={modelName} onChange={(e) => setModelName(e.target.value)} placeholder="Nákladný vagón Es" required readOnly={!isEditMode} />
                                <LabeledInput label="Ev. číslo" id="evidencneCisloVagon" value={evidencneCislo} onChange={(e) => setEvidencneCislo(e.target.value)} placeholder="Es 21 54 000 000-0" readOnly={!isEditMode} />
                                <LabeledInput label="Typ vagónu" id="typeVagonu" type="select" value={typeVagonu} onChange={(e) => setTypeVagonu(e.target.value)} options={wagonTypeOptions} required readOnly={!isEditMode} />
                                <LabeledInput label="Výrobca" id="manufacturerVagon" type="select" value={manufacturer} onChange={(e) => setManufacturer(e.target.value)} options={manufacturerOptions} required readOnly={!isEditMode} />
                                <LabeledInput label="Mierka" id="scaleVagon" type="select" value={scale} onChange={(e) => setScale(e.target.value)} options={scaleOptions} required readOnly={!isEditMode} />
                                <LabeledInput label="Epocha" id="epochaVagon" type="select" value={epocha} onChange={(e) => setEpocha(e.target.value)} options={epochaOptions} readOnly={!isEditMode} />
                                <LabeledInput label="Správa" id="spravaVagon" type="select" value={sprava} onChange={(e) => setSprava(e.target.value)} options={spravaOptions} readOnly={!isEditMode} />
                                <LabeledInput label="Depo" id="depoVagon" value={depo} onChange={(e) => setDepo(e.target.value)} placeholder="Praha" options={depoOptions} readOnly={!isEditMode} />
                                <LabeledInput label="Stav" id="stavVagon" type="select" value={stav} onChange={(e) => setStav(e.target.value)} options={stavOptions} readOnly={!isEditMode} />
                                <LabeledInput label="Dátum zak." id="datumZakupeniaModeluVagon" type="date" value={datumZakupeniaModelu} onChange={(e) => setDatumZakupeniaModelu(e.target.value)} readOnly={!isEditMode} />
                                <LabeledInput label="Cena" id="cenaModeluVagon" type="number" value={cenaModelu} onChange={(e) => setCenaModelu(e.target.value)} placeholder="50.00" step="0.01" readOnly={!isEditMode} />
                                <LabeledInput label="Obchodník" id="obchodnikModeluVagon" type="select" value={obchodnikModelu} onChange={(e) => setObchodnikModelu(e.target.value)} options={obchodnikOptions} readOnly={!isEditMode} />
                                <LabeledInput label="Záruka do" id="zarukaModeluVagon" type="date" value={zarukaModelu} onChange={(e) => setZarukaModelu(e.target.value)} readOnly={!isEditMode} />
                                <LabeledInput label="Umiestnenie" id="locationVagon" value={location} onChange={(e) => setLocation(e.target.value)} placeholder="sklad 3" readOnly={!isEditMode} />
                                <LabeledInput label="Stav obalu" id="packagingConditionVagon" type="select" value={packagingCondition} onChange={(e) => setPackagingCondition(e.target.value)} options={packagingConditionOptions} readOnly={!isEditMode} />
                                <LabeledInput label="Hodnotenie stavu" id="conditionRatingVagon" type="select" value={conditionRating} onChange={(e) => setConditionRating(e.target.value)} options={conditionRatingOptions} readOnly={!isEditMode} />
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div className="flex flex-col gap-6">
                            <div className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200 flex flex-col gap-3">
                                <h2 className="text-xl font-semibold text-blue-700 mb-2">Technické údaje</h2>
                                <LabeledInput label="Dĺžka (mm)" id="dlzkaNaraznikyVagon" type="number" value={dlzkaNarazniky} onChange={(e) => setDlzkaNarazniky(e.target.value)} placeholder="150" readOnly={!isEditMode} />
                                <LabeledInput label="Hmotnosť (t)" id="hmotnostVagon" type="number" value={hmotnost} onChange={(e) => setHmotnost(e.target.value)} placeholder="0.1" step="0.01" readOnly={!isEditMode} />
                                <LabeledInput label="Počet náprav" id="pocetNapravVagon" type="number" value={pocetNaprav} onChange={(e) => setPocetNaprav(parseInt(e.target.value) || 0)} min="2" readOnly={!isEditMode} />
                                <LabeledInput label="Typ spriahly" id="typSpriahlyVagon" type="select" value={typSpriahly} onChange={(e) => setTypSpriahly(e.target.value)} options={typSpriahlyOptions} readOnly={!isEditMode} />
                            </div>

                            <div className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200">
                                <h2 className="text-xl font-semibold text-blue-700 mb-4">Servis a údržba</h2>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-3">
                                    <LabeledInput label="Dátum posledného servisu" id="lastServiceDateVagon" type="date" value={lastServiceDateVagon} onChange={(e) => setLastServiceDateVagon(e.target.value)} readOnly={!isEditMode} />
                                    <LabeledInput label="Náklady na servis (€)" id="serviceCostVagon" type="number" value={serviceCostVagon} onChange={(e) => setServiceCostVagon(e.target.value)} placeholder="0.00" step="0.01" readOnly={!isEditMode} />
                                    <LabeledInput label="Servis vykonal" id="servicedByVagon" type="text" value={servicedByVagon} onChange={(e) => setServicedByVagon(e.target.value)} placeholder="Meno / Firma" readOnly={!isEditMode} />
                                    <LabeledInput label="Popis vykonaných prác" id="serviceDescriptionVagon" type="textarea" value={serviceDescriptionVagon} onChange={(e) => setServiceDescriptionVagon(e.target.value)} placeholder="Popis čistenia, mazania, výmeny súčiastok..." readOnly={!isEditMode} spanFull={true} />
                                </div>
                            </div>

                            <div className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200">
                                <h2 className="text-xl font-semibold text-blue-700 mb-4">Modifikácie a úpravy</h2>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-3">
                                    <LabeledInput label="Dátum modifikácie" id="lastModificationDateVagon" type="date" value={lastModificationDateVagon} onChange={(e) => setLastModificationDateVagon(e.target.value)} readOnly={!isEditMode} />
                                    <LabeledInput label="Náklady na modifikáciu (€)" id="modificationCostVagon" type="number" value={modificationCostVagon} onChange={(e) => setModificationCostVagon(e.target.value)} placeholder="0.00" step="0.01" readOnly={!isEditMode} />
                                    <LabeledInput label="Popis vykonanej úpravy" id="modificationDescriptionVagon" type="textarea" value={modificationDescriptionVagon} onChange={(e) => setModificationDescriptionVagon(e.target.value)} placeholder="Digitálne spriahlo, osvetlenie, patinovanie, zmena zvuku..." readOnly={!isEditMode} spanFull={true} />
                                </div>
                            </div>

                            <div className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200">
                                <h2 className="text-xl font-semibold text-blue-700 mb-4">Príslušenstvo k modelu</h2>
                                <LabeledInput label="Zoznam príslušenstva" id="modelAccessoriesVagon" type="textarea" value={modelAccessories} onChange={(e) => setModelAccessories(e.target.value)} placeholder="Náhradné diely, spriahla, doplnky, originálne balenie..." readOnly={!isEditMode} spanFull={true} />
                            </div>
                        </div>

                        <div className="flex flex-col gap-6">
                            <div className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200 flex flex-col gap-3">
                                <h2 className="text-xl font-semibold text-blue-700 mb-2">Špecifické údaje</h2>
                                <LabeledInput label="Typ nákladu" id="typNakladu" type="text" value={typNakladu} onChange={(e) => setTypNakladu(e.target.value)} placeholder="Uhlí" options={typNakladuOptions} readOnly={!isEditMode} />
                                <LabeledInput label="Farba" id="farba" type="text" value={farba} onChange={(e) => setFarba(e.target.value)} placeholder="Hnedá" options={farbaOptions} readOnly={!isEditMode} />
                                <LabeledInput label="Popis:" id="popisVagon" type="textarea" value={popis} onChange={(e) => setPopis(e.target.value)} placeholder="Ďalšie informácie o vagóne..." readOnly={!isEditMode} />
                            </div>

                            <div className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200">
                                <h2 className="text-xl font-semibold text-blue-700 mb-4">Dekodér</h2>
                                <LabeledInput
                                    label="Vyberte dekodér"
                                    id="selectedDecoderIdVagon"
                                    type="select"
                                    value={selectedDecoderIdVagon}
                                    onChange={(e) => setSelectedDecoderIdVagon(e.target.value)}
                                    options={decoderOptionsVagon}
                                    readOnly={!isEditMode}
                                />
                                {selectedDecoderIdVagon && selectedDecoderIdVagon !== 'none' && (
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-3 mt-4">
                                        <LabeledInput label="Rozhranie" id="rozhranieDekoderVagon" type="select" value={rozhranieDekoderVagon} onChange={(e) => setRozhranieDekoderVagon(e.target.value)} options={rozhranieDekoderOptions} readOnly={!isEditMode} />
                                        <LabeledInput label="Typ" id="typDekoderVagon" type="select" value={typDekoderVagon} onChange={(e) => setTypDekoderVagon(e.target.value)} options={typDekoderOptions} readOnly={!isEditMode} />
                                        <LabeledInput label="Výrobca" id="vyrobcaDekoderVagon" type="select" value={vyrobcaDekoderVagon} onChange={(e) => setVyrobcaDekoderVagon(e.target.value)} options={vyrobcaDekoderOptions} readOnly={!isEditMode} />
                                        <LabeledInput label="Adresa" id="adresaDekoderVagon" value={adresaDekoderVagon} onChange={(e) => setAdresaDekoderVagon(e.target.value)} placeholder="3" readOnly={!isEditMode} />
                                        <LabeledInput label="Dátum zak." id="datumZakupeniaDekoderVagon" type="date" value={datumZakupeniaDekoderVagon} onChange={(e) => setDatumZakupeniaDekoderVagon(e.target.value)} readOnly={!isEditMode} />
                                        <LabeledInput label="Cena" id="cenaDekoderVagon" type="number" value={cenaDekoderVagon} onChange={(e) => setCenaDekoderVagon(e.target.value)} placeholder="50.00" step="0.01" readOnly={!isEditMode} />
                                        <LabeledInput label="Obchodník" id="obchodnikDekoderVagon" type="select" value={obchodnikDekoderVagon} onChange={(e) => setObchodnikDekoderVagon(e.target.value)} options={obchodnikOptions} readOnly={!isEditMode} />
                                        <LabeledInput label="Záruka do" id="zarukaDekoderVagon" type="date" value={zarukaDekoderVagon} onChange={(e) => setZarukaDekoderVagon(e.target.value)} readOnly={!isEditMode} />
                                        <LabeledInput label="Poznámky k CV:" id="cvNotesVagon" type="textarea" value={cvNotesVagon} onChange={(e) => setCvNotesVagon(e.target.value)} placeholder="Špecifické nastavenia, zvukové funkcie..." readOnly={!isEditMode} spanFull={true} />

                                        <h3 className="text-lg font-semibold text-blue-600 mt-4 col-span-full">Spotreba energie</h3>
                                        <LabeledInput label="Napätie (V)" id="voltageDekoderVagon" type="number" value={voltageDekoderVagon} onChange={(e) => setVoltageDekoderVagon(e.target.value)} placeholder="12" step="0.1" readOnly={!isEditMode} />
                                        <LabeledInput label="Prúd (mA)" id="currentDekoderVagon" type="number" value={currentDekoderVagon} onChange={(e) => setCurrentDekoderVagon(e.target.value)} placeholder="50" step="1" readOnly={!isEditMode} />

                                        <h3 className="text-lg font-semibold text-blue-600 mt-4 col-span-full">DCC funkcie (F0-F28)</h3>
                                        <LabeledInput label="Popis funkcií" id="dccFunctionsVagon" type="textarea" value={dccFunctionsVagon} onChange={(e) => setDccFunctionsVagon(e.target.value)} placeholder="F0: Svetlá, F1: Vnútorné osvetlenie..." readOnly={!isEditMode} spanFull={true} />
                                    </div>
                                )}
                            </div>

                            <div className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200">
                                <h2 className="text-xl font-semibold text-blue-700 mb-4">Posledná jazda / Prevádzkové hodiny</h2>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-3">
                                    <LabeledInput label="Dátum poslednej prevádzky" id="lastOperationDateVagon" type="date" value={lastOperationDateVagon} onChange={(e) => setLastOperationDateVagon(e.target.value)} readOnly={!isEditMode} />
                                    <LabeledInput label="Prevádzkové hodiny" id="operatingHoursVagon" type="number" value={operatingHoursVagon} onChange={(e) => setCurrentDekoderVagon(e.target.value)} placeholder="0" min="0" readOnly={!isEditMode} />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        });

        // --- Komponent: forms/PrislusenstvoForm.js ---
        const PrislusenstvoForm = React.forwardRef(({ initialData, isEditMode, showMessage, allReferenceData }, ref) => {
            const [modelName, setModelName] = useState(initialData?.modelName || '');
            const [subCategory, setSubCategory] = useState(initialData?.subCategory || '');
            const [manufacturer, setManufacturer] = useState(initialData?.manufacturer || '');
            const [scale, setScale] = useState(initialData?.scale || '');
            const [datumZakupeniaModelu, setDatumZakupeniaModelu] = useState(initialData?.datumZakupeniaModelu || '');
            const [cenaModelu, setCenaModelu] = useState(initialData?.cenaModelu || '');
            const [obchodnikModelu, setObchodnikModelu] = useState(initialData?.obchodnikModelu || '');
            const [zarukaModelu, setZarukaModelu] = useState(initialData?.zarukaModelu || '');
            const [popis, setPopis] = useState(initialData?.popis || '');
            const [imageFile, setImageFile] = useState(null);
            const [imagePreviewUrl, setImagePreviewUrl] = useState(initialData?.imageDataUrl || '');

            const [evidencneCisloAuto, setEvidencneCisloAuto] = useState(initialData?.evidencneCisloAuto || '');
            const [stavAuto, setStavAuto] = useState(initialData?.stavAuto || '');
            const [znackaAuto, setZnackaAuto] = useState(initialData?.znackaAuto || '');
            const [zvukAuto, setZvukAuto] = useState(initialData?.zvukAuto || false);
            const [osvetlenieAuto, setOsvetlenieAuto] = useState(initialData?.osvetlenieAuto || false);
            const [selectedDecoderIdAuto, setSelectedDecoderIdAuto] = useState(initialData?.selectedDecoderIdAuto || '');
            const [cvNotesAuto, setCvNotesAuto] = useState(initialData?.cvNotesAuto || '');
            const [datumZakupeniaDekoderAuto, setDatumZakupeniaDekoderAuto] = useState(initialData?.datumZakupeniaDekoderAuto || '');
            const [cenaDekoderAuto, setCenaDekoderAuto] = useState(initialData?.cenaDekoderAuto || '');
            const [obchodnikDekoderAuto, setObchodnikDekoderAuto] = useState(initialData?.obchodnikDekoderAuto || '');
            const [cvAdresaDekoderAuto, setCvAdresaDekoderAuto] = useState(initialData?.cvAdresaDekoderAuto || '');
            const [decoderNotesAuto, setDecoderNotesAuto] = useState(initialData?.decoderNotesAuto || '');
            const [vyrobcaDekoderAuto, setVyrobcaDekoderAuto] = useState(initialData?.vyrobcaDekoderAuto || '');
            const [dccFunctionsAuto, setDccFunctionsAuto] = useState(initialData?.dccFunctionsAuto || '');
            const [lastOperationDateAuto, setLastOperationDateAuto] = useState(initialData?.lastOperationAuto?.date || '');
            const [operatingHoursAuto, setOperatingHoursAuto] = useState(initialData?.lastOperationAuto?.hours || '');
            const [voltageDekoderAuto, setVoltageDekoderAuto] = useState(initialData?.powerConsumptionAuto?.voltageDekoderAuto || '');
            const [currentDekoderAuto, setCurrentDekoderAuto] = useState(initialData?.powerConsumptionAuto?.currentDekoderAuto || '');

            const decoderOptionsAuto = [
                { value: 'decoderC', label: 'Dekodér C' },
                { value: 'decoderD', label: 'Dekodér D' },
                { value: 'none', label: 'Žiadny dekodér' },
            ];

            const [buildingType, setBuildingType] = useState(initialData?.buildingType || '');
            const [patina, setPatina] = useState(initialData?.patina || false);
            const [buildingLength, setBuildingLength] = useState(initialData?.buildingLength || '');
            const [buildingWidth, setBuildingWidth] = useState(initialData?.buildingWidth || '');
            const [buildingHeight, setBuildingHeight] = useState(initialData?.buildingHeight || '');
            const [buildingMaterial, setBuildingMaterial] = useState(initialData?.buildingMaterial || '');
            const [buildingNotes, setBuildingNotes] = useState(initialData?.buildingNotes || '');

            const [selectedDecoderIdBuilding, setSelectedDecoderIdBuilding] = useState(initialData?.selectedDecoderIdBuilding || '');
            const [rozhranieDekoderBuilding, setRozhranieDekoderBuilding] = useState(initialData?.rozhranieDekoderBuilding || '');
            const [typDekoderBuilding, setTypDekoderBuilding] = useState(initialData?.typDekoderBuilding || '');
            const [vyrobcaDekoderBuilding, setVyrobcaDekoderBuilding] = useState(initialData?.vyrobcaDekoderBuilding || '');
            const [adresaDekoderBuilding, setAdresaDekoderBuilding] = useState(initialData?.adresaDekoderBuilding || '');
            const [datumZakupeniaDekoderBuilding, setDatumZakupeniaDekoderBuilding] = useState(initialData?.datumZakupeniaDekoderBuilding || '');
            const [cenaDekoderBuilding, setCenaDekoderBuilding] = useState(initialData?.cenaDekoderBuilding || '');
            const [obchodnikDekoderBuilding, setObchodnikDekoderBuilding] = useState(initialData?.obchodnikDekoderBuilding || '');
            const [zarukaDekoderBuilding, setZarukaDekoderBuilding] = useState(initialData?.zarukaDekoderBuilding || '');
            const [cvNotesBuilding, setCvNotesBuilding] = useState(initialData?.cvNotesBuilding || '');
            const [dccFunctionsBuilding, setDccFunctionsBuilding] = useState(initialData?.dccFunctionsBuilding || '');
            const [lastOperationDateBuilding, setLastOperationDateBuilding] = useState(initialData?.lastOperationBuilding?.date || '');
            const [operatingHoursBuilding, setOperatingHoursBuilding] = useState(initialData?.lastOperationBuilding?.hours || '');
            const [voltageDekoderBuilding, setVoltageDekoderBuilding] = useState(initialData?.powerConsumptionBuilding?.voltageDekoderBuilding || '');
            const [currentDekoderBuilding, setCurrentDekoderBuilding] = useState(initialData?.powerConsumptionBuilding?.currentDekoderBuilding || '');

            const decoderOptionsBuilding = [
                { value: 'decoderE', label: 'Dekodér E (Osvetlenie)' },
                { value: 'decoderF', label: 'Dekodér F (Zvuk)' },
                { value: 'none', label: 'Žiadny dekodér' },
            ];

            const [trackType, setTrackType] = useState(initialData?.trackType || '');
            const [trackLengthRadius, setTrackLengthRadius] = useState(initialData?.trackLengthRadius || '');
            const [trackMaterial, setTrackMaterial] = useState(initialData?.trackMaterial || '');
            const [trackSystem, setTrackSystem] = useState(initialData?.trackSystem || '');
            const [trackNotes, setTrackNotes] = useState(initialData?.trackNotes || '');
            const [pocetKolajnic, setPocetKolajnic] = useState(initialData?.pocetKolajnic || '');

            const [komunikaciaSignal, setKomunikaciaSignal] = useState(initialData?.komunikaciaSignal || '');
            const [signalType, setSignalType] = useState(initialData?.signalType || '');
            const [signalKind, setSignalKind] = useState(initialData?.signalKind || '');
            const [pocetSvetielSignal, setPocetSvetielSignal] = useState(initialData?.pocetSvetielSignal || '');
            const [signalNotes, setSignalNotes] = useState(initialData?.signalNotes || '');

            const [selectedDecoderIdSignal, setSelectedDecoderIdSignal] = useState(initialData?.selectedDecoderIdSignal || '');
            const [rozhranieDekoderSignal, setRozhranieDekoderSignal] = useState(initialData?.rozhranieDekoderSignal || '');
            const [typDekoderSignal, setTypDekoderSignal] = useState(initialData?.typDekoderSignal || '');
            const [vyrobcaDekoderSignal, setVyrobcaDekoderSignal] = useState(initialData?.vyrobcaDekoderSignal || '');
            const [adresaDekoderSignal, setAdresaDekoderSignal] = useState(initialData?.adresaDekoderSignal || '');
            const [datumZakupeniaDekoderSignal, setDatumZakupeniaDekoderSignal] = useState(initialData?.datumZakupeniaDekoderSignal || '');
            const [cenaDekoderSignal, setCenaDekoderSignal] = useState(initialData?.cenaDekoderSignal || '');
            const [obchodnikDekoderSignal, setObchodnikDekoderSignal] = useState(initialData?.obchodnikDekoderSignal || '');
            const [zarukaDekoderSignal, setZarukaDekoderSignal] = useState(initialData?.zarukaDekoderSignal || '');
            const [cvNotesSignal, setCvNotesSignal] = useState(initialData?.cvNotesSignal || '');
            const [dccFunctionsSignal, setDccFunctionsSignal] = useState(initialData?.dccFunctionsSignal || '');
            const [lastOperationDateSignal, setLastOperationDateSignal] = useState(initialData?.lastOperationSignal?.date || '');
            const [operatingHoursSignal, setOperatingHoursSignal] = useState(initialData?.lastOperationSignal?.hours || '');
            const [voltageDekoderSignal, setVoltageDekoderSignal] = useState(initialData?.powerConsumptionSignal?.voltageDekoderSignal || '');
            const [currentDekoderSignal, setCurrentDekoderSignal] = useState(initialData?.powerConsumptionSignal?.currentDekoderSignal || '');

            const decoderOptionsSignal = [
                { value: 'decoderG', label: 'Dekodér G (Návestidlá)' },
                { value: 'decoderH', label: 'Dekodér H (Funkčný)' },
                { value: 'none', label: 'Žiadny dekodér' },
            ];

            const [figureType, setFigureType] = useState(initialData?.figureType || '');
            const [figureQuantity, setFigureQuantity] = useState(initialData?.figureQuantity || '');
            const [figureNotes, setFigureNotes] = useState(initialData?.figureNotes || '');

            const [lightingType, setLightingType] = useState(initialData?.lightingType || '');
            const [lightingPower, setLightingPower] = useState(initialData?.lightingPower || '');
            const [lightingColor, setLightingColor] = useState(initialData?.lightingColor || '');
            const [lightingNotes, setLightingNotes] = useState(initialData?.lightingNotes || '');
            const [voltageLighting, setVoltageLighting] = useState(initialData?.powerConsumptionLighting?.voltageLighting || '');
            const [currentLighting, setCurrentLighting] = useState(initialData?.powerConsumptionLighting?.currentLighting || '');

            const [lastServiceDatePrislusenstvo, setLastServiceDatePrislusenstvo] = useState(initialData?.serviceHistoryPrislusenstvo?.lastServiceDatePrislusenstvo || '');
            const [serviceDescriptionPrislusenstvo, setServiceDescriptionPrislusenstvo] = useState(initialData?.serviceHistoryPrislusenstvo?.serviceDescriptionPrislusenstvo || '');
            const [serviceCostPrislusenstvo, setServiceCostPrislusenstvo] = useState(initialData?.serviceHistoryPrislusenstvo?.serviceCostPrislusenstvo || '');
            const [servicedByPrislusenstvo, setServicedByPrislusenstvo] = useState(initialData?.serviceHistoryPrislusenstvo?.servicedByPrislusenstvo || '');

            const [lastModificationDatePrislusenstvo, setLastModificationDatePrislusenstvo] = useState(initialData?.modificationsPrislusenstvo?.lastModificationDatePrislusenstvo || '');
            const [modificationDescriptionPrislusenstvo, setModificationDescriptionPrislusenstvo] = useState(initialData?.modificationsPrislusenstvo?.modificationDescriptionPrislusenstvo || '');
            const [modificationCostPrislusenstvo, setModificationCostPrislusenstvo] = useState(initialData?.modificationsPrislusenstvo?.modificationCostPrislusenstvo || '');

            const [location, setLocation] = useState(initialData?.location || '');
            const [packagingCondition, setPackagingCondition] = useState(initialData?.packagingCondition || '');
            const [conditionRating, setConditionRating] = useState(initialData?.conditionRating || '');
            const [modelAccessories, setModelAccessories] = useState(initialData?.modelAccessories || '');

            const [dccFunctionsPrislusenstvo, setDccFunctionsPrislusenstvo] = useState(initialData?.dccFunctionsPrislusenstvo || '');
            const [lastOperationDatePrislusenstvo, setLastOperationDatePrislusenstvo] = useState(initialData?.lastOperationPrislusenstvo?.date || '');
            const [operatingHoursPrislusenstvo, setOperatingHoursPrislusenstvo] = useState(initialData?.lastOperationPrislusenstvo?.hours || '');
            const [voltagePrislusenstvo, setVoltagePrislusenstvo] = useState(initialData?.powerConsumptionPrislusenstvo?.voltagePrislusenstvo || '');
            const [currentPrislusenstvo, setCurrentPrislusenstvo] = useState(initialData?.powerConsumptionPrislusenstvo?.currentPrislusenstvo || '');

            // Dynamické možnosti z allReferenceData
            const manufacturerOptions = allReferenceData.manufacturers || [];
            const scaleOptions = allReferenceData.scales || [];
            const obchodnikOptions = allReferenceData.dealers || [];
            const packagingConditionOptions = allReferenceData.packagingConditions || [];
            const conditionRatingOptions = allReferenceData.conditionRatings || [];
            const carBrandOptions = allReferenceData.carBrands || [];
            const carConditionOptions = allReferenceData.carConditions || [];
            const buildingTypeOptions = allReferenceData.buildingTypes || [];
            const buildingMaterialOptions = allReferenceData.buildingMaterials || [];
            const trackTypeOptions = allReferenceData.trackTypes || [];
            const trackMaterialOptions = allReferenceData.trackMaterials || [];
            const trackSystemOptions = allReferenceData.trackSystems || [];
            const signalCommunicationOptions = allReferenceData.signalCommunications || [];
            const signalTypeOptions = allReferenceData.signalTypes || [];
            const signalKindOptions = allReferenceData.signalKinds || [];
            const figureTypeOptions = allReferenceData.figureTypes || [];
            const lightingTypeOptions = allReferenceData.lightingTypes || [];
            const rozhranieDekoderOptions = allReferenceData.decoderInterfaces || [];
            const typDekoderOptions = allReferenceData.decoderTypes || [];
            const vyrobcaDekoderOptions = allReferenceData.decoderManufacturers || [];

            useEffect(() => {
                setModelName(initialData?.modelName || '');
                setSubCategory(initialData?.subCategory || '');
                setManufacturer(initialData?.manufacturer || '');
                setScale(initialData?.scale || '');
                setDatumZakupeniaModelu(initialData?.datumZakupeniaModelu || '');
                setCenaModelu(initialData?.cenaModelu || '');
                setObchodnikModelu(initialData?.obchodnikModelu || '');
                setZarukaModelu(initialData?.zarukaModelu || '');
                setPopis(initialData?.popis || '');
                setImagePreviewUrl(initialData?.imageDataUrl || '');
                setImageFile(null);

                setEvidencneCisloAuto(initialData?.evidencneCisloAuto || '');
                setStavAuto(initialData?.stavAuto || '');
                setZnackaAuto(initialData?.znackaAuto || '');
                setZvukAuto(initialData?.zvukAuto || false);
                setOsvetlenieAuto(initialData?.osvetlenieAuto || false);
                setSelectedDecoderIdAuto(initialData?.selectedDecoderIdAuto || '');
                setCvNotesAuto(initialData?.cvNotesAuto || '');
                setDatumZakupeniaDekoderAuto(initialData?.datumZakupeniaDekoderAuto || '');
                setCenaDekoderAuto(initialData?.cenaDekoderAuto || '');
                setObchodnikDekoderAuto(initialData?.obchodnikDekoderAuto || '');
                setCvAdresaDekoderAuto(initialData?.cvAdresaDekoderAuto || '');
                setDecoderNotesAuto(initialData?.decoderNotesAuto || '');
                setVyrobcaDekoderAuto(initialData?.vyrobcaDekoderAuto || '');
                setDccFunctionsAuto(initialData?.dccFunctionsAuto || '');
                setLastOperationDateAuto(initialData?.lastOperationAuto?.date || '');
                setOperatingHoursAuto(initialData?.lastOperationAuto?.hours || '');
                setVoltageDekoderAuto(initialData?.powerConsumptionAuto?.voltageDekoderAuto || '');
                setCurrentDekoderAuto(initialData?.powerConsumptionAuto?.currentDekoderAuto || '');

                setBuildingType(initialData?.buildingType || '');
                setPatina(initialData?.patina || false);
                setBuildingLength(initialData?.buildingLength || '');
                setBuildingWidth(initialData?.buildingWidth || '');
                setBuildingHeight(initialData?.buildingHeight || '');
                setBuildingMaterial(initialData?.buildingMaterial || '');
                setBuildingNotes(initialData?.buildingNotes || '');
                setSelectedDecoderIdBuilding(initialData?.selectedDecoderIdBuilding || '');
                setRozhranieDekoderBuilding(initialData?.rozhranieDekoderBuilding || '');
                setTypDekoderBuilding(initialData?.typDekoderBuilding || '');
                setVyrobcaDekoderBuilding(initialData?.vyrobcaDekoderBuilding || '');
                setAdresaDekoderBuilding(initialData?.adresaDekoderBuilding || '');
                setDatumZakupeniaDekoderBuilding(initialData?.datumZakupeniaDekoderBuilding || '');
                setCenaDekoderBuilding(initialData?.cenaDekoderBuilding || '');
                setObchodnikDekoderBuilding(initialData?.obchodnikDekoderBuilding || '');
                setZarukaDekoderBuilding(initialData?.zarukaDekoderBuilding || '');
                setCvNotesBuilding(initialData?.cvNotesBuilding || '');
                setDccFunctionsBuilding(initialData?.dccFunctionsBuilding || '');
                setLastOperationDateBuilding(initialData?.lastOperationBuilding?.date || '');
                setOperatingHoursBuilding(initialData?.lastOperationBuilding?.hours || '');
                setVoltageDekoderBuilding(initialData?.powerConsumptionBuilding?.voltageDekoderBuilding || '');
                setCurrentDekoderBuilding(initialData?.powerConsumptionBuilding?.currentDekoderBuilding || '');

                setTrackType(initialData?.trackType || '');
                setTrackLengthRadius(initialData?.trackLengthRadius || '');
                setTrackMaterial(initialData?.trackMaterial || '');
                setTrackSystem(initialData?.trackSystem || '');
                setTrackNotes(initialData?.trackNotes || '');
                setPocetKolajnic(initialData?.pocetKolajnic || '');

                setKomunikaciaSignal(initialData?.komunikaciaSignal || '');
                setSignalType(initialData?.signalType || '');
                setSignalKind(initialData?.signalKind || '');
                setPocetSvetielSignal(initialData?.pocetSvetielSignal || '');
                setSignalNotes(initialData?.signalNotes || '');
                setSelectedDecoderIdSignal(initialData?.selectedDecoderIdSignal || '');
                setRozhranieDekoderSignal(initialData?.rozhranieDekoderSignal || '');
                setTypDekoderSignal(initialData?.typDekoderSignal || '');
                setVyrobcaDekoderSignal(initialData?.vyrobcaDekoderSignal || '');
                setAdresaDekoderSignal(initialData?.adresaDekoderSignal || '');
                setDatumZakupeniaDekoderSignal(initialData?.datumZakupeniaDekoderSignal || '');
                setCenaDekoderSignal(initialData?.cenaDekoderSignal || '');
                setObchodnikDekoderSignal(initialData?.obchodnikDekoderSignal || '');
                setZarukaDekoderSignal(initialData?.zarukaDekoderSignal || '');
                setCvNotesSignal(initialData?.cvNotesSignal || '');
                setDccFunctionsSignal(initialData?.dccFunctionsSignal || '');
                setLastOperationDateSignal(initialData?.lastOperationSignal?.date || '');
                setOperatingHoursSignal(initialData?.lastOperationSignal?.hours || '');
                setVoltageDekoderSignal(initialData?.powerConsumptionSignal?.voltageDekoderSignal || '');
                setCurrentDekoderSignal(initialData?.powerConsumptionSignal?.currentDekoderSignal || '');

                setFigureType(initialData?.figureType || '');
                setFigureQuantity(initialData?.figureQuantity || '');
                setFigureNotes(initialData?.figureNotes || '');

                setLightingType(initialData?.lightingType || '');
                setLightingPower(initialData?.lightingPower || '');
                setLightingColor(initialData?.lightingColor || '');
                setLightingNotes(initialData?.lightingNotes || '');
                setVoltageLighting(initialData?.powerConsumptionLighting?.voltageLighting || '');
                setCurrentLighting(initialData?.powerConsumptionLighting?.currentLighting || '');

                setLastServiceDatePrislusenstvo(initialData?.serviceHistoryPrislusenstvo?.lastServiceDatePrislusenstvo || '');
                setServiceDescriptionPrislusenstvo(initialData?.serviceHistoryPrislusenstvo?.serviceDescriptionPrislusenstvo || '');
                setServiceCostPrislusenstvo(initialData?.serviceHistoryPrislusenstvo?.serviceCostPrislusenstvo || '');
                setServicedByPrislusenstvo(initialData?.serviceHistoryPrislusenstvo?.servicedByPrislusenstvo || '');

                setLastModificationDatePrislusenstvo(initialData?.modificationsPrislusenstvo?.lastModificationDatePrislusenstvo || '');
                setModificationDescriptionPrislusenstvo(initialData?.modificationsPrislusenstvo?.modificationDescriptionPrislusenstvo || '');
                setModificationCostPrislusenstvo(initialData?.modificationsPrislusenstvo?.modificationCostPrislusenstvo || '');

                setLocation(initialData?.location || '');
                setPackagingCondition(initialData?.packagingCondition || '');
                setConditionRating(initialData?.conditionRating || '');
                setModelAccessories(initialData?.modelAccessories || '');

                setDccFunctionsPrislusenstvo(initialData?.dccFunctionsPrislusenstvo || '');
                setLastOperationDatePrislusenstvo(initialData?.lastOperationPrislusenstvo?.date || '');
                setOperatingHoursPrislusenstvo(initialData?.lastOperationPrislusenstvo?.hours || '');
                setVoltagePrislusenstvo(initialData?.powerConsumptionPrislusenstvo?.voltagePrislusenstvo || '');
                setCurrentPrislusenstvo(initialData?.powerConsumptionPrislusenstvo?.currentPrislusenstvo || '');

            }, [initialData]);

            const handleImageChange = (file) => {
                if (!isEditMode) return;
                if (file) {
                    setImageFile(file);
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setImagePreviewUrl(reader.result);
                    };
                    reader.readAsDataURL(file);
                } else {
                    setImageFile(null);
                    setImagePreviewUrl('');
                }
            };

            useImperativeHandle(ref, () => ({
                getCurrentFormData: () => {
                    const commonData = {
                        modelName,
                        category: 'Príslušenstvo',
                        subCategory,
                        manufacturer,
                        scale,
                        datumZakupeniaModelu,
                        cenaModelu,
                        obchodnikModelu,
                        zarukaModelu,
                        popis,
                        imageFileName: imageFile ? imageFile.name : (initialData?.imageFileName || null),
                        imageDataUrl: imagePreviewUrl,
                        location,
                        packagingCondition,
                        conditionRating,
                        modelAccessories
                    };

                    let specificData = {};
                    switch (subCategory) {
                        case 'Autá':
                            specificData = {
                                evidencneCisloAuto,
                                stavAuto,
                                znackaAuto,
                                zvukAuto,
                                osvetlenieAuto,
                                selectedDecoderIdAuto,
                                cvNotesAuto,
                                datumZakupeniaDekoderAuto,
                                cenaDekoderAuto,
                                obchodnikDekoderAuto,
                                cvAdresaDekoderAuto,
                                decoderNotesAuto,
                                vyrobcaDekoderAuto,
                                dccFunctionsAuto,
                                lastOperationAuto: { date: lastOperationDateAuto, hours: operatingHoursAuto },
                                powerConsumptionAuto: { voltageDekoderAuto, currentDekoderAuto },
                                serviceHistoryPrislusenstvo: { lastServiceDatePrislusenstvo, serviceDescriptionPrislusenstvo, serviceCostPrislusenstvo, servicedByPrislusenstvo },
                                modificationsPrislusenstvo: { lastModificationDatePrislusenstvo, modificationDescriptionPrislusenstvo, modificationCostPrislusenstvo }
                            };
                            break;
                        case 'Budovy':
                            specificData = {
                                buildingType,
                                patina,
                                buildingLength,
                                buildingWidth,
                                buildingHeight,
                                buildingMaterial,
                                buildingNotes,
                                selectedDecoderIdBuilding,
                                rozhranieDekoderBuilding,
                                typDekoderBuilding,
                                vyrobcaDekoderBuilding,
                                adresaDekoderBuilding,
                                datumZakupeniaDekoderBuilding,
                                cenaDekoderBuilding,
                                obchodnikDekoderBuilding,
                                zarukaDekoderBuilding,
                                cvNotesBuilding,
                                dccFunctionsBuilding,
                                lastOperationBuilding: { date: lastOperationDateBuilding, hours: operatingHoursBuilding },
                                powerConsumptionBuilding: { voltageDekoderBuilding, currentDekoderBuilding },
                                serviceHistoryPrislusenstvo: { lastServiceDatePrislusenstvo, serviceDescriptionPrislusenstvo, serviceCostPrislusenstvo, servicedByPrislusenstvo },
                                modificationsPrislusenstvo: { lastModificationDatePrislusenstvo, modificationDescriptionPrislusenstvo, modificationCostPrislusenstvo }
                            };
                            break;
                        case 'Koľaje':
                            specificData = {
                                trackType, trackLengthRadius, trackMaterial, trackSystem, trackNotes, pocetKolajnic,
                                serviceHistoryPrislusenstvo: { lastServiceDatePrislusenstvo, serviceDescriptionPrislusenstvo, serviceCostPrislusenstvo, servicedByPrislusenstvo },
                                modificationsPrislusenstvo: { lastModificationDatePrislusenstvo, modificationDescriptionPrislusenstvo, modificationCostPrislusenstvo }
                            };
                            break;
                        case 'Návestidlá':
                            specificData = {
                                komunikaciaSignal,
                                signalType,
                                signalKind,
                                pocetSvetielSignal,
                                signalNotes,
                                selectedDecoderIdSignal,
                                rozhranieDekoderSignal,
                                typDekoderSignal,
                                vyrobcaDekoderSignal,
                                adresaDekoderSignal,
                                datumZakupeniaDekoderSignal,
                                cenaDekoderSignal,
                                obchodnikDekoderSignal,
                                zarukaDekoderSignal,
                                cvNotesSignal,
                                dccFunctionsSignal,
                                lastOperationSignal: { date: lastOperationDateSignal, hours: operatingHoursSignal },
                                powerConsumptionSignal: { voltageDekoderSignal, currentDekoderSignal },
                                serviceHistoryPrislusenstvo: { lastServiceDatePrislusenstvo, serviceDescriptionPrislusenstvo, serviceCostPrislusenstvo, servicedByPrislusenstvo },
                                modificationsPrislusenstvo: { lastModificationDatePrislusenstvo, modificationDescriptionPrislusenstvo, modificationCostPrislusenstvo }
                            };
                            break;
                        case 'Figúrky':
                            specificData = { figureType, figureQuantity, figureNotes };
                            break;
                        case 'Osvetlenie':
                            specificData = {
                                lightingType, lightingPower, lightingColor, lightingNotes,
                                powerConsumptionLighting: { voltageLighting, currentLighting }
                            };
                            break;
                        case 'Iné':
                            specificData = {
                                otherNotes: popis,
                                dccFunctionsPrislusenstvo,
                                lastOperationPrislusenstvo: { date: lastOperationDatePrislusenstvo, hours: operatingHoursPrislusenstvo },
                                powerConsumptionPrislusenstvo: { voltagePrislusenstvo, currentPrislusenstvo },
                                serviceHistoryPrislusenstvo: { lastServiceDatePrislusenstvo, serviceDescriptionPrislusenstvo, serviceCostPrislusenstvo, servicedByPrislusenstvo },
                                modificationsPrislusenstvo: { lastModificationDatePrislusenstvo, modificationDescriptionPrislusenstvo, modificationCostPrislusenstvo }
                            };
                            break;
                        default:
                            break;
                    }
                    return { ...commonData, ...specificData };
                },
            }));

            return (
                <div className="bg-white p-8 rounded-xl shadow-lg border border-blue-100">
                    <h1 className="text-3xl font-bold text-blue-800 mb-6">{isEditMode ? (initialData ? 'Upraviť príslušenstvo' : 'Pridať nové príslušenstvo') : 'Detail príslušenstva'}</h1>

                    <div className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200 mb-6">
                        <h2 className="text-xl font-semibold text-blue-700 mb-4">Základné údaje príslušenstva</h2>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div className="md:col-span-1 md:row-span-full flex flex-col items-center justify-start p-4 border border-gray-300 rounded-md bg-white min-h-[250px] relative">
                                <div className="image-preview-container">
                                    {imagePreviewUrl ? (
                                        <img src={imagePreviewUrl} alt="Náhľad obrázka" className="max-w-full max-h-full object-contain" />
                                    ) : (
                                        <div className="image-preview-placeholder">
                                            Žiadny obrázok k dispozícii
                                        </div>
                                    )}
                                </div>
                                <div className="w-full px-2 mt-4">
                                    <LabeledInput label="Nahrať obrázok" id="imagePrislusenstvo" type="file" onChange={handleImageChange} readOnly={!isEditMode} />
                                </div>
                            </div>

                            <div className="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-3">
                                <LabeledInput label="Názov príslušenstva" id="modelNamePrislusenstvo" value={modelName} onChange={(e) => setModelName(e.target.value)} placeholder="Auto Škoda 120" required readOnly={!isEditMode} />
                                <LabeledInput
                                    label="Typ príslušenstva"
                                    id="subCategoryPrislusenstvo"
                                    type="select"
                                    value={subCategory}
                                    onChange={(e) => setSubCategory(e.target.value)}
                                    options={["Autá", "Budovy", "Koľaje", "Návestidlá", "Figúrky", "Osvetlenie", "Iné"]} // Keep hardcoded as these are main categories
                                    required
                                    readOnly={!isEditMode}
                                />
                                <LabeledInput label="Výrobca" id="manufacturerPrislusenstvo" type="select" value={manufacturer} onChange={(e) => setManufacturer(e.target.value)} options={manufacturerOptions} required readOnly={!isEditMode} />
                                <LabeledInput label="Mierka" id="scalePrislusenstvo" type="select" value={scale} onChange={(e) => setScale(e.target.value)} options={scaleOptions} required readOnly={!isEditMode} />
                                <LabeledInput label="Dátum zak." id="datumZakupeniaModeluPrislusenstvo" type="date" value={datumZakupeniaModelu} onChange={(e) => setDatumZakupeniaModelu(e.target.value)} readOnly={!isEditMode} />
                                <LabeledInput label="Cena" id="cenaModeluPrislusenstvo" type="number" value={cenaModelu} onChange={(e) => setCenaModelu(e.target.value)} placeholder="15.00" step="0.01" readOnly={!isEditMode} />
                                <LabeledInput label="Obchodník" id="obchodnikModeluPrislusenstvo" type="select" value={obchodnikModelu} onChange={(e) => setObchodnikModelu(e.target.value)} options={obchodnikOptions} readOnly={!isEditMode} />
                                <LabeledInput label="Záruka do" id="zarukaModeluPrislusenstvo" type="date" value={zarukaModelu} onChange={(e) => setZarukaModelu(e.target.value)} readOnly={!isEditMode} />
                                {subCategory === 'Autá' && (
                                    <>
                                        <LabeledInput label="Ev. číslo modelu" id="evidencneCisloAuto" value={evidencneCisloAuto} onChange={(e) => setEvidencneCisloAuto(e.target.value)} placeholder="Určí užívateľ" readOnly={!isEditMode} />
                                        <LabeledInput label="Stav" id="stavAuto" type="select" value={stavAuto} onChange={(e) => setStavAuto(e.target.value)} options={carConditionOptions} readOnly={!isEditMode} />
                                    </>
                                )}
                                <LabeledInput label="Umiestnenie" id="locationPrislusenstvo" value={location} onChange={(e) => setLocation(e.target.value)} placeholder="na koľajisku" readOnly={!isEditMode} />
                                <LabeledInput label="Stav obalu" id="packagingConditionPrislusenstvo" type="select" value={packagingCondition} onChange={(e) => setPackagingCondition(e.target.value)} options={packagingConditionOptions} readOnly={!isEditMode} />
                                <LabeledInput label="Hodnotenie stavu" id="conditionRatingPrislusenstvo" type="select" value={conditionRating} onChange={(e) => setConditionRating(e.target.value)} options={conditionRatingOptions} readOnly={!isEditMode} />
                                <LabeledInput label="Popis:" id="popisPrislusenstvo" type="textarea" value={popis} onChange={(e) => setPopis(e.target.value)} placeholder="Ďalšie informácie o príslušenstve..." readOnly={!isEditMode} spanFull={true} />
                            </div>
                        </div>
                    </div>

                    {subCategory && (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                            {(() => {
                                switch (subCategory) {
                                    case 'Autá':
                                        return (
                                            <>
                                                <div className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200 flex flex-col gap-3">
                                                    <h3 className="text-xl font-semibold text-blue-700 mb-2">Technické údaje</h3>
                                                    <LabeledInput label="Značka" id="znackaAuto" value={znackaAuto} onChange={(e) => setZnackaAuto(e.target.value)} placeholder="Škoda" options={carBrandOptions} readOnly={!isEditMode} />
                                                    <LabeledCheckbox label="Zvuk" id="zvukAuto" checked={zvukAuto} onChange={(e) => setZvukAuto(e.target.checked)} readOnly={!isEditMode} />
                                                    <LabeledCheckbox label="Osvetlenie" id="osvetlenieAuto" checked={osvetlenieAuto} onChange={(e) => setOsvetlenieAuto(e.target.checked)} readOnly={!isEditMode} />
                                                    <div className="mt-4">
                                                        <h3 className="text-xl font-semibold text-blue-700 mb-2">Údaje o dekodéri</h3>
                                                        <LabeledInput
                                                            label="Vyberte dekodér"
                                                            id="selectedDecoderIdAuto"
                                                            type="select"
                                                            value={selectedDecoderIdAuto}
                                                            onChange={(e) => setSelectedDecoderIdAuto(e.target.value)}
                                                            options={decoderOptionsAuto}
                                                            readOnly={!isEditMode}
                                                        />
                                                        {selectedDecoderIdAuto && selectedDecoderIdAuto !== 'none' && (
                                                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-3 mt-4">
                                                                <LabeledInput label="Dátum zak." id="datumZakupeniaDekoderAuto" type="date" value={datumZakupeniaDekoderAuto} onChange={(e) => setDatumZakupeniaDekoderAuto(e.target.value)} readOnly={!isEditMode} />
                                                                <LabeledInput label="Cena" id="cenaDekoderAuto" type="number" value={cenaDekoderAuto} onChange={(e) => setCenaDekoderAuto(e.target.value)} placeholder="30.00" step="0.01" readOnly={!isEditMode} />
                                                                <LabeledInput label="Obchodník" id="obchodnikDekoderAuto" type="select" value={obchodnikDekoderAuto} onChange={(e) => setObchodnikDekoderAuto(e.target.value)} options={obchodnikOptions} readOnly={!isEditMode} />
                                                                <LabeledInput label="CV adresa dekodéra" id="cvAdresaDekoderAuto" value={cvAdresaDekoderAuto} onChange={(e) => setCvAdresaDekoderAuto(e.target.value)} placeholder="1" readOnly={!isEditMode} />
                                                                <LabeledInput label="Výrobca" id="vyrobcaDekoderAuto" type="select" value={vyrobcaDekoderAuto} onChange={(e) => setVyrobcaDekoderAuto(e.target.value)} options={vyrobcaDekoderOptions} readOnly={!isEditMode} />
                                                                <LabeledInput label="Poznámky k CV" id="cvNotesAuto" type="textarea" value={cvNotesAuto} onChange={(e) => setCvNotesAuto(e.target.value)} placeholder="Poznámky k CV nastaveniam..." readOnly={!isEditMode} spanFull={true} />
                                                                <LabeledInput label="Poznámky k dekodéru:" id="decoderNotesAuto" type="textarea" value={decoderNotesAuto} onChange={(e) => setDecoderNotesAuto(e.target.value)} placeholder="Ďalšie poznámky k dekodéru auta..." readOnly={!isEditMode} spanFull={true} />
                                                                <h3 className="text-lg font-semibold text-blue-600 mt-4 col-span-full">DCC funkcie (F0-F28)</h3>
                                                                <LabeledInput label="Popis funkcií" id="dccFunctionsAuto" type="textarea" value={dccFunctionsAuto} onChange={(e) => setDccFunctionsAuto(e.target.value)} placeholder="F0: Svetlá, F1: Klaksón..." readOnly={!isEditMode} spanFull={true} />
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                                <div className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200 flex flex-col gap-3">
                                                    <h3 className="text-xl font-semibold text-blue-700 mb-2">Spotreba energie</h3>
                                                    <LabeledInput label="Napätie (V)" id="voltageDekoderAuto" type="number" value={voltageDekoderAuto} onChange={(e) => setVoltageDekoderAuto(e.target.value)} placeholder="12" step="0.1" readOnly={!isEditMode} />
                                                    <LabeledInput label="Prúd (mA)" id="currentDekoderAuto" type="number" value={currentDekoderAuto} onChange={(e) => setCurrentDekoderAuto(e.target.value)} placeholder="50" step="1" readOnly={!isEditMode} />
                                                    <div className="mt-4">
                                                        <h3 className="text-xl font-semibold text-blue-700 mb-2">Posledná jazda / Prevádzkové hodiny</h3>
                                                        <LabeledInput label="Dátum poslednej prevádzky" id="lastOperationDateAuto" type="date" value={lastOperationDateAuto} onChange={(e) => setLastOperationDateAuto(e.target.value)} readOnly={!isEditMode} />
                                                        <LabeledInput label="Prevádzkové hodiny" id="operatingHoursAuto" type="number" value={operatingHoursAuto} onChange={(e) => setOperatingHoursAuto(e.target.value)} placeholder="0" min="0" readOnly={!isEditMode} />
                                                    </div>
                                                </div>
                                            </>
                                        );
                                    case 'Budovy':
                                        return (
                                            <>
                                                <div className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200">
                                                    <h3 className="text-xl font-semibold text-blue-700 mb-2">Technické údaje</h3>
                                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-3">
                                                        <LabeledInput label="Druh budovy" id="buildingType" type="text" value={buildingType} onChange={(e) => setBuildingType(e.target.value)} placeholder="Staničná budova" options={buildingTypeOptions} required readOnly={!isEditMode} />
                                                        <LabeledCheckbox label="Patina" id="patina" checked={patina} onChange={(e) => setPatina(e.target.checked)} readOnly={!isEditMode} />
                                                        <LabeledInput label="Dĺžka (mm)" id="buildingLength" type="number" value={buildingLength} onChange={(e) => setBuildingLength(e.target.value)} placeholder="200" readOnly={!isEditMode} />
                                                        <LabeledInput label="Šírka (mm)" id="buildingWidth" type="number" value={buildingWidth} onChange={(e) => setBuildingWidth(e.target.value)} placeholder="150" readOnly={!isEditMode} />
                                                        <LabeledInput label="Výška (mm)" id="buildingHeight" type="number" value={buildingHeight} onChange={(e) => setBuildingHeight(e.target.value)} placeholder="100" readOnly={!isEditMode} />
                                                        <LabeledInput label="Materiál" id="buildingMaterial" type="select" value={buildingMaterial} onChange={(e) => setBuildingMaterial(e.target.value)} options={buildingMaterialOptions} readOnly={!isEditMode} />
                                                        <LabeledInput label="Poznámky k budove:" id="buildingNotes" type="textarea" value={buildingNotes} onChange={(e) => setBuildingNotes(e.target.value)} placeholder="Ďalšie informácie o budove..." readOnly={!isEditMode} spanFull={true} />
                                                    </div>
                                                    <div className="mt-4">
                                                        <h3 className="text-xl font-semibold text-blue-700 mb-2">Údaje o dekodéri</h3>
                                                        <LabeledInput
                                                            label="Vyberte dekodér"
                                                            id="selectedDecoderIdBuilding"
                                                            type="select"
                                                            value={selectedDecoderIdBuilding}
                                                            onChange={(e) => setSelectedDecoderIdBuilding(e.target.value)}
                                                            options={decoderOptionsBuilding}
                                                            readOnly={!isEditMode}
                                                        />
                                                        {selectedDecoderIdBuilding && selectedDecoderIdBuilding !== 'none' && (
                                                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-3 mt-4">
                                                                <LabeledInput label="Rozhranie" id="rozhranieDekoderBuilding" type="select" value={rozhranieDekoderBuilding} onChange={(e) => setRozhranieDekoderBuilding(e.target.value)} options={rozhranieDekoderOptions} readOnly={!isEditMode} />
                                                                <LabeledInput label="Typ" id="typDekoderBuilding" type="select" value={typDekoderBuilding} onChange={(e) => setTypDekoderBuilding(e.target.value)} options={typDekoderOptions} readOnly={!isEditMode} />
                                                                <LabeledInput label="Výrobca" id="vyrobcaDekoderBuilding" type="select" value={vyrobcaDekoderBuilding} onChange={(e) => setVyrobcaDekoderBuilding(e.target.value)} options={vyrobcaDekoderOptions} readOnly={!isEditMode} />
                                                                <LabeledInput label="Adresa" id="adresaDekoderBuilding" value={adresaDekoderBuilding} onChange={(e) => setAdresaDekoderBuilding(e.target.value)} placeholder="3" readOnly={!isEditMode} />
                                                                <LabeledInput label="Dátum zak." id="datumZakupeniaDekoderBuilding" type="date" value={datumZakupeniaDekoderBuilding} onChange={(e) => setDatumZakupeniaDekoderBuilding(e.target.value)} readOnly={!isEditMode} />
                                                                <LabeledInput label="Cena" id="cenaDekoderBuilding" type="number" value={cenaDekoderBuilding} onChange={(e) => setCenaDekoderBuilding(e.target.value)} placeholder="50.00" step="0.01" readOnly={!isEditMode} />
                                                                <LabeledInput label="Obchodník" id="obchodnikDekoderBuilding" type="select" value={obchodnikDekoderBuilding} onChange={(e) => setObchodnikDekoderBuilding(e.target.value)} options={obchodnikOptions} readOnly={!isEditMode} />
                                                                <LabeledInput label="Záruka do" id="zarukaDekoderBuilding" type="date" value={zarukaDekoderBuilding} onChange={(e) => setZarukaDekoderBuilding(e.target.value)} readOnly={!isEditMode} />
                                                                <LabeledInput label="Poznámky k CV:" id="cvNotesBuilding" type="textarea" value={cvNotesBuilding} onChange={(e) => setCvNotesBuilding(e.target.value)} placeholder="Špecifické nastavenia, zvukové funkcie..." readOnly={!isEditMode} spanFull={true} />
                                                                <h3 className="text-lg font-semibold text-blue-600 mt-4 col-span-full">DCC funkcie (F0-F28)</h3>
                                                                <LabeledInput label="Popis funkcií" id="dccFunctionsBuilding" type="textarea" value={dccFunctionsBuilding} onChange={(e) => setDccFunctionsBuilding(e.target.value)} placeholder="F0: Osvetlenie, F1: Zvuk zvonu..." readOnly={!isEditMode} spanFull={true} />
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                                <div className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200 flex flex-col gap-3">
                                                    <h3 className="text-xl font-semibold text-blue-700 mb-2">Spotreba energie</h3>
                                                    <LabeledInput label="Napätie (V)" id="voltageDekoderBuilding" type="number" value={voltageDekoderBuilding} onChange={(e) => setVoltageDekoderBuilding(e.target.value)} placeholder="12" step="0.1" readOnly={!isEditMode} />
                                                    <LabeledInput label="Prúd (mA)" id="currentDekoderBuilding" type="number" value={currentDekoderBuilding} onChange={(e) => setCurrentDekoderBuilding(e.target.value)} placeholder="100" step="1" readOnly={!isEditMode} />
                                                    <div className="mt-4">
                                                        <h3 className="text-xl font-semibold text-blue-700 mb-2">Posledná jazda / Prevádzkové hodiny</h3>
                                                        <LabeledInput label="Dátum poslednej prevádzky" id="lastOperationDateBuilding" type="date" value={lastOperationDateBuilding} onChange={(e) => setLastOperationDateBuilding(e.target.value)} readOnly={!isEditMode} />
                                                        <LabeledInput label="Prevádzkové hodiny" id="operatingHoursBuilding" type="number" value={operatingHoursBuilding} onChange={(e) => setOperatingHoursBuilding(e.target.value)} placeholder="0" min="0" readOnly={!isEditMode} />
                                                    </div>
                                                </div>
                                            </>
                                        );
                                    case 'Koľaje':
                                        return (
                                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-3">
                                                <LabeledInput label="Typ koľaje" id="trackType" type="select" value={trackType} onChange={(e) => setTrackType(e.target.value)} options={trackTypeOptions} required readOnly={!isEditMode} />
                                                <LabeledInput label="Dĺžka/Polomer (mm)" id="trackLengthRadius" value={trackLengthRadius} onChange={(e) => setTrackLengthRadius(e.target.value)} placeholder="230 mm / R1" readOnly={!isEditMode} />
                                                <LabeledInput label="Materiál" id="trackMaterial" type="select" value={trackMaterial} onChange={(e) => setTrackMaterial(e.target.value)} options={trackMaterialOptions} readOnly={!isEditMode} />
                                                <LabeledInput label="Systém" id="trackSystem" type="select" value={trackSystem} onChange={(e) => setTrackSystem(e.target.value)} options={trackSystemOptions} readOnly={!isEditMode} />
                                                <LabeledInput label="Počet" id="pocetKolajnic" type="number" value={pocetKolajnic} onChange={(e) => setPocetKolajnic(parseInt(e.target.value) || '')} min="1" required readOnly={!isEditMode} />
                                                <LabeledInput label="Poznámky ku koľaji:" id="trackNotes" type="textarea" value={trackNotes} onChange={(e) => setTrackNotes(e.target.value)} placeholder="Špecifické detaily o koľaji..." readOnly={!isEditMode} spanFull={true} />
                                            </div>
                                        );
                                    case 'Návestidlá':
                                        return (
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                                <div className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200 flex flex-col gap-3">
                                                    <h3 className="text-xl font-semibold text-blue-700 mb-2">Technické údaje</h3>
                                                    <LabeledInput label="Komunikácia" id="komunikaciaSignal" type="select" value={komunikaciaSignal} onChange={(e) => setKomunikaciaSignal(e.target.value)} options={signalCommunicationOptions} required readOnly={!isEditMode} />
                                                    <LabeledInput label="Typ návestidla" id="signalType" type="select" value={signalType} onChange={(e) => setSignalType(e.target.value)} options={signalTypeOptions} required readOnly={!isEditMode} />
                                                    <LabeledInput label="Druh" id="signalKind" type="select" value={signalKind} onChange={(e) => setSignalKind(e.target.value)} options={signalKindOptions} required readOnly={!isEditMode} />
                                                    {signalType === 'Svetelné' && (
                                                        <LabeledInput label="Počet svetiel" id="pocetSvetielSignal" type="number" value={pocetSvetielSignal} onChange={(e) => setPocetSvetielSignal(parseInt(e.target.value) || '')} min="1" required readOnly={!isEditMode} />
                                                    )}
                                                    <LabeledInput label="Poznámka:" id="signalNotes" type="textarea" value={signalNotes} onChange={(e) => setSignalNotes(e.target.value)} placeholder="Ďalšie informácie o návestidle..." readOnly={!isEditMode} spanFull={true} />
                                                    <div className="mt-4">
                                                        <h3 className="text-xl font-semibold text-blue-700 mb-2">Údaje o dekodéri</h3>
                                                        <LabeledInput
                                                            label="Vyberte dekodér"
                                                            id="selectedDecoderIdSignal"
                                                            type="select"
                                                            value={selectedDecoderIdSignal}
                                                            onChange={(e) => setSelectedDecoderIdSignal(e.target.value)}
                                                            options={decoderOptionsSignal}
                                                            readOnly={!isEditMode}
                                                        />
                                                        {selectedDecoderIdSignal && selectedDecoderIdSignal !== 'none' && (
                                                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-3 mt-4">
                                                                <LabeledInput label="Rozhranie" id="rozhranieDekoderSignal" type="select" value={rozhranieDekoderSignal} onChange={(e) => setRozhranieDekoderSignal(e.target.value)} options={rozhranieDekoderOptions} readOnly={!isEditMode} />
                                                                <LabeledInput label="Typ" id="typDekoderSignal" type="select" value={typDekoderSignal} onChange={(e) => setTypDekoderSignal(e.target.value)} options={typDekoderOptions} readOnly={!isEditMode} />
                                                                <LabeledInput label="Výrobca" id="vyrobcaDekoderSignal" type="select" value={vyrobcaDekoderSignal} onChange={(e) => setVyrobcaDekoderSignal(e.target.value)} options={vyrobcaDekoderOptions} readOnly={!isEditMode} />
                                                                <LabeledInput label="Adresa" id="adresaDekoderSignal" value={adresaDekoderSignal} onChange={(e) => setAdresaDekoderSignal(e.target.value)} placeholder="3" readOnly={!isEditMode} />
                                                                <LabeledInput label="Dátum zak." id="datumZakupeniaDekoderSignal" type="date" value={datumZakupeniaDekoderSignal} onChange={(e) => setDatumZakupeniaDekoderSignal(e.target.value)} readOnly={!isEditMode} />
                                                                <LabeledInput label="Cena" id="cenaDekoderSignal" type="number" value={cenaDekoderSignal} onChange={(e) => setCenaDekoderSignal(e.target.value)} placeholder="50.00" step="0.01" readOnly={!isEditMode} />
                                                                <LabeledInput label="Obchodník" id="obchodnikDekoderSignal" type="select" value={obchodnikDekoderSignal} onChange={(e) => setObchodnikDekoderSignal(e.target.value)} options={obchodnikOptions} readOnly={!isEditMode} />
                                                                <LabeledInput label="Záruka do" id="zarukaDekoderSignal" type="date" value={zarukaDekoderSignal} onChange={(e) => setZarukaDekoderSignal(e.target.value)} readOnly={!isEditMode} />
                                                                <LabeledInput label="Poznámky k CV:" id="cvNotesSignal" type="textarea" value={cvNotesSignal} onChange={(e) => setCvNotesSignal(e.target.value)} placeholder="Špecifické nastavenia, zvukové funkcie..." readOnly={!isEditMode} spanFull={true} />
                                                                <h3 className="text-lg font-semibold text-blue-600 mt-4 col-span-full">DCC funkcie (F0-F28)</h3>
                                                                <LabeledInput label="Popis funkcií" id="dccFunctionsSignal" type="textarea" value={dccFunctionsSignal} onChange={(e) => setDccFunctionsSignal(e.target.value)} placeholder="F0: Svetlá, F1: Zmena aspektu..." readOnly={!isEditMode} spanFull={true} />
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                                <div className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200 flex flex-col gap-3 items-center justify-center">
                                                    <h3 className="text-xl font-semibold text-blue-700 mb-2">Vizualizácia návestidla</h3>
                                                    <SignalVisualization signalType={signalType} pocetSvetiel={pocetSvetielSignal} signalKind={signalKind} isEditMode={isEditMode} />
                                                    <div className="mt-4 w-full">
                                                        <h3 className="text-xl font-semibold text-blue-700 mb-2">Spotreba energie</h3>
                                                        <LabeledInput label="Napätie (V)" id="voltageDekoderSignal" type="number" value={voltageDekoderSignal} onChange={(e) => setVoltageDekoderSignal(e.target.value)} placeholder="12" step="0.1" readOnly={!isEditMode} />
                                                        <LabeledInput label="Prúd (mA)" id="currentDekoderSignal" type="number" value={currentDekoderSignal} onChange={(e) => setCurrentDekoderSignal(e.target.value)} placeholder="50" step="1" readOnly={!isEditMode} />
                                                    </div>
                                                    <div className="mt-4 w-full">
                                                        <h3 className="text-xl font-semibold text-blue-700 mb-2">Posledná jazda / Prevádzkové hodiny</h3>
                                                        <LabeledInput label="Dátum poslednej prevádzky" id="lastOperationDateSignal" type="date" value={lastOperationDateSignal} onChange={(e) => setLastOperationDateSignal(e.target.value)} readOnly={!isEditMode} />
                                                        <LabeledInput label="Prevádzkové hodiny" id="operatingHoursSignal" type="number" value={operatingHoursSignal} onChange={(e) => setOperatingHoursSignal(e.target.value)} placeholder="0" min="0" readOnly={!isEditMode} />
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    case 'Figúrky':
                                        return (
                                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-3">
                                                <LabeledInput label="Typ figúrky" id="figureType" type="select" value={figureType} onChange={(e) => setFigureType(e.target.value)} options={figureTypeOptions} required readOnly={!isEditMode} />
                                                <LabeledInput label="Počet kusov" id="figureQuantity" type="number" value={figureQuantity} onChange={(e) => setFigureQuantity(e.target.value)} placeholder="10" readOnly={!isEditMode} />
                                                <LabeledInput label="Poznámky k figúrke:" id="figureNotes" type="textarea" value={figureNotes} onChange={(e) => setFigureNotes(e.target.value)} placeholder="Ďalšie informácie o figúrke..." readOnly={!isEditMode} spanFull={true} />
                                            </div>
                                        );
                                    case 'Osvetlenie':
                                        return (
                                            <>
                                                <div className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200 flex flex-col gap-3">
                                                    <h3 className="text-xl font-semibold text-blue-700 mb-2">Technické údaje</h3>
                                                    <LabeledInput label="Typ osvetlenia" id="lightingType" type="select" value={lightingType} onChange={(e) => setLightingType(e.target.value)} options={lightingTypeOptions} required readOnly={!isEditMode} />
                                                    <LabeledInput label="Výkon (V/mA)" id="lightingPower" value={lightingPower} onChange={(e) => setLightingPower(e.target.value)} placeholder="12V / 20mA" readOnly={!isEditMode} />
                                                    <LabeledInput label="Farba svetla" id="lightingColor" type="text" value={lightingColor} onChange={(e) => setLightingColor(e.target.value)} placeholder="Teplá biela" readOnly={!isEditMode} />
                                                    <LabeledInput label="Poznámky k osvetleniu:" id="lightingNotes" type="textarea" value={lightingNotes} onChange={(e) => setLightingNotes(e.target.value)} placeholder="Špecifické detaily o osvetlení..." readOnly={!isEditMode} spanFull={true} />
                                                </div>
                                                <div className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200 flex flex-col gap-3">
                                                    <h3 className="text-xl font-semibold text-blue-700 mb-2">Spotreba energie</h3>
                                                    <LabeledInput label="Napätie (V)" id="voltageLighting" type="number" value={voltageLighting} onChange={(e) => setVoltageLighting(e.target.value)} placeholder="12" step="0.1" readOnly={!isEditMode} />
                                                    <LabeledInput label="Prúd (mA)" id="currentLighting" type="number" value={currentLighting} onChange={(e) => setCurrentLighting(e.target.value)} placeholder="20" step="1" readOnly={!isEditMode} />
                                                </div>
                                            </>
                                        );
                                    case 'Iné':
                                        return (
                                            <>
                                                <div className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200 flex flex-col gap-3">
                                                    <h3 className="text-xl font-semibold text-blue-700 mb-2">Technické údaje</h3>
                                                    <LabeledInput label="Ďalšie poznámky:" id="otherNotes" type="textarea" value={popis} onChange={(e) => setPopis(e.target.value)} placeholder="Akékoľvek ďalšie informácie o príslušenstve..." readOnly={!isEditMode} spanFull={true} />
                                                    <div className="mt-4">
                                                        <h3 className="text-xl font-semibold text-blue-600 mt-4 col-span-full">DCC funkcie (F0-F28)</h3>
                                                        <LabeledInput label="Popis funkcií" id="dccFunctionsPrislusenstvo" type="textarea" value={dccFunctionsPrislusenstvo} onChange={(e) => setDccFunctionsPrislusenstvo(e.target.value)} placeholder="F0: Funkcia 1, F1: Funkcia 2..." readOnly={!isEditMode} spanFull={true} />
                                                    </div>
                                                </div>
                                                <div className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200 flex flex-col gap-3">
                                                    <h3 className="text-xl font-semibold text-blue-700 mb-2">Spotreba energie</h3>
                                                    <LabeledInput label="Napätie (V)" id="voltagePrislusenstvo" type="number" value={voltagePrislusenstvo} onChange={(e) => setVoltagePrislusenstvo(e.target.value)} placeholder="12" step="0.1" readOnly={!isEditMode} />
                                                    <LabeledInput label="Prúd (mA)" id="currentPrislusenstvo" type="number" value={currentPrislusenstvo} onChange={(e) => setCurrentPrislusenstvo(e.target.value)} placeholder="50" step="1" readOnly={!isEditMode} />
                                                    <div className="mt-4">
                                                        <h3 className="text-xl font-semibold text-blue-700 mb-2">Posledná jazda / Prevádzkové hodiny</h3>
                                                        <LabeledInput label="Dátum poslednej prevádzky" id="lastOperationDatePrislusenstvo" type="date" value={lastOperationDatePrislusenstvo} onChange={(e) => setLastOperationDatePrislusenstvo(e.target.value)} readOnly={!isEditMode} />
                                                        <LabeledInput label="Prevádzkové hodiny" id="operatingHoursPrislusenstvo" type="number" value={operatingHoursPrislusenstvo} onChange={(e) => setOperatingHoursPrislusenstvo(e.target.value)} placeholder="0" min="0" readOnly={!isEditMode} />
                                                    </div>
                                                </div>
                                            </>
                                        );
                                    default:
                                        return null;
                                }
                            })()}
                        </div>
                    )}

                    {subCategory && (subCategory === 'Autá' || subCategory === 'Budovy' || subCategory === 'Koľaje' || subCategory === 'Návestidlá' || subCategory === 'Iné') && (
                        <div className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200 mt-6">
                            <h2 className="text-xl font-semibold text-blue-700 mb-4">Servis a údržba</h2>
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-3">
                                <LabeledInput label="Dátum posledného servisu" id="lastServiceDatePrislusenstvo" type="date" value={lastServiceDatePrislusenstvo} onChange={(e) => setLastServiceDatePrislusenstvo(e.target.value)} readOnly={!isEditMode} />
                                <LabeledInput label="Náklady na servis (€)" id="serviceCostPrislusenstvo" type="number" value={serviceCostPrislusenstvo} onChange={(e) => setServiceCostPrislusenstvo(e.target.value)} placeholder="0.00" step="0.01" readOnly={!isEditMode} />
                                <LabeledInput label="Servis vykonal" id="servicedByPrislusenstvo" type="text" value={servicedByPrislusenstvo} onChange={(e) => setServicedByPrislusenstvo(e.target.value)} placeholder="Meno / Firma" readOnly={!isEditMode} />
                                <LabeledInput label="Popis vykonaných prác" id="serviceDescriptionPrislusenstvo" type="textarea" value={serviceDescriptionPrislusenstvo} onChange={(e) => setServiceDescriptionPrislusenstvo(e.target.value)} placeholder="Popis čistenia, mazania, výmeny súčiastok..." readOnly={!isEditMode} spanFull={true} />
                            </div>
                        </div>
                    )}
                    {subCategory && (subCategory === 'Autá' || subCategory === 'Budovy' || subCategory === 'Koľaje' || subCategory === 'Návestidlá' || subCategory === 'Iné') && (
                        <div className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200 mt-6">
                            <h2 className="text-xl font-semibold text-blue-700 mb-4">Modifikácie a úpravy</h2>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-3">
                                <LabeledInput label="Dátum modifikácie" id="lastModificationDatePrislusenstvo" type="date" value={lastModificationDatePrislusenstvo} onChange={(e) => setLastModificationDatePrislusenstvo(e.target.value)} readOnly={!isEditMode} />
                                <LabeledInput label="Náklady na modifikáciu (€)" id="modificationCostPrislusenstvo" type="number" value={modificationCostPrislusenstvo} onChange={(e) => setModificationCostPrislusenstvo(e.target.value)} placeholder="0.00" step="0.01" readOnly={!isEditMode} />
                                <LabeledInput label="Popis vykonanej úpravy" id="modificationDescriptionPrislusenstvo" type="textarea" value={modificationDescriptionPrislusenstvo} onChange={(e) => setModificationDescriptionPrislusenstvo(e.target.value)} placeholder="Digitálne spriahlo, osvetlenie, patinovanie, zmena zvuku..." readOnly={!isEditMode} spanFull={true} />
                            </div>
                        </div>
                    )}

                    {subCategory && (subCategory === 'Autá' || subCategory === 'Budovy' || subCategory === 'Koľaje' || subCategory === 'Návestidlá' || subCategory === 'Iné') && (
                        <div className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200 mt-6">
                            <h2 className="text-xl font-semibold text-blue-700 mb-4">Príslušenstvo k modelu</h2>
                            <LabeledInput label="Zoznam príslušenstva" id="modelAccessoriesPrislusenstvo" type="textarea" value={modelAccessories} onChange={(e) => setModelAccessories(e.target.value)} placeholder="Náhradné diely, spriahla, doplnky, originálne balenie..." readOnly={!isEditMode} spanFull={true} />
                        </div>
                    )}
                </div>
            );
        });

        // --- Komponent: pages/HomePage.js ---
        function HomePage() {
            return (
                <>
                    <h1 className="text-4xl font-extrabold text-blue-800 mb-6">Vitajte v evidencii modelov!</h1>
                    <p className="text-lg text-gray-700 leading-relaxed">
                        Tu sa bude zobrazovať detailný obsah vašich modelov, formuláre a tabuľky.
                        V ďalších krokoch sem pridáme záložky a konkrétne formuláre.
                        Aplikácia je navrhnutá s dôrazom na jednoduchosť a intuitívne ovládanie.
                    </p>
                    <div className="mt-10 p-6 bg-white rounded-xl shadow-lg border border-blue-100">
                        <p className="text-blue-700 font-semibold text-xl">
                            <span className="text-blue-500 mr-2">🚂</span> Pripravte sa na správu vašej železničnej zbierky s ľahkosťou!
                        </p>
                    </div>
                </>
            );
        }

        // --- Komponent: pages/SearchPage.js ---
        function SearchPage() {
            return (
                <main className="flex-1 p-8 bg-gray-50">
                    <h1 className="text-4xl font-extrabold text-blue-800 mb-8">Vyhľadávanie</h1>
                    <p className="text-lg text-gray-700 leading-relaxed">
                        Tu bude implementované vyhľadávanie modelov podľa rôznych kritérií.
                    </p>
                    <div className="mt-10 p-6 bg-white rounded-xl shadow-lg border border-blue-100">
                        <p className="text-blue-700 font-semibold text-xl">
                            <span className="text-blue-500 mr-2">🔍</span> Nájdite presne to, čo hľadáte.
                        </p>
                    </div>
                </main>
            );
        }

        // --- Komponent: pages/ExportCsvPage.js ---
        function ExportCsvPage() {
            return (
                <main className="flex-1 p-8 bg-gray-50">
                    <h1 className="text-4xl font-extrabold text-blue-800 mb-8">Export CSV</h1>
                    <p className="text-lg text-gray-700 leading-relaxed">
                        Tu bude funkcia pre export vašich dát do formátu CSV.
                    </p>
                    <div className="mt-10 p-6 bg-white rounded-xl shadow-lg border border-blue-100">
                        <p className="text-blue-700 font-semibold text-xl">
                            <span className="text-blue-500 mr-2">📊</span> Exportujte svoje dáta pre ďalšiu analýzu.
                        </p>
                    </div>
                </main>
            );
        }

        // --- Komponent: ReferenceDataManager.js (Nový komponent pre správu číselníkov) ---
        const ReferenceDataManager = ({ categoryId, categoryLabel, db, userId, showMessage, appId }) => {
            console.log(`[ReferenceDataManager] Rendering for category: ${categoryLabel}, db: ${!!db}, userId: ${userId}, appId: ${appId}`);
            const [items, setItems] = useState([]);
            const [newItem, setNewItem] = useState('');
            const [editingItem, setEditingItem] = useState(null); // { value: 'oldValue' }

            // Firestore referencia pre túto konkrétnu kategóriu číselníka
            // Dáta číselníkov sú verejné (public)
            const categoryDocRef = db && appId ? window.firebase.doc(db, `artifacts/${appId}/public/data/referenceData`, categoryId) : null;

            useEffect(() => {
                console.log(`[ReferenceDataManager] useEffect for ${categoryLabel}: db is ${!!db}, appId is ${appId}, categoryDocRef is ${!!categoryDocRef}`);
                if (db && appId && categoryDocRef) { // Explicitly check db and appId here
                    const unsubscribe = window.firebase.onSnapshot(categoryDocRef, (docSnap) => {
                        console.log(`[ReferenceDataManager] onSnapshot for ${categoryLabel}: docSnap exists: ${docSnap.exists()}`);
                        if (docSnap.exists()) {
                            try { // Added try-catch around data processing
                                const data = docSnap.data();
                                const fetchedValues = data.values || [];
                                setItems(fetchedValues);
                                console.log(`[ReferenceDataManager] Loaded items for ${categoryLabel}:`, fetchedValues);
                            } catch (dataError) {
                                console.error(`[ReferenceDataManager] Chyba pri spracovaní dát pre číselník ${categoryId}:`, dataError);
                                showMessage(`Chyba pri spracovaní dát pre číselník ${categoryLabel}: ${dataError.message}`);
                            }
                        } else {
                            setItems([]); // Dokument kategórie ešte neexistuje
                            console.log(`[ReferenceDataManager] No document for ${categoryLabel}, setting empty array.`);
                        }
                    }, (error) => {
                        console.error(`[ReferenceDataManager] Chyba pri načítaní číselníka ${categoryId} (onSnapshot error):`, error);
                        showMessage(`Chyba pri načítaní číselníka ${categoryLabel}: ${error.message}`);
                    });
                    return () => {
                        console.log(`[ReferenceDataManager] Unsubscribing from ${categoryLabel}`);
                        unsubscribe();
                    };
                } else {
                    console.log(`[ReferenceDataManager] Not subscribing for ${categoryLabel}, db, appId or categoryDocRef not ready.`);
                }
            }, [db, appId, categoryDocRef, categoryId, categoryLabel, showMessage]);

            const handleAddItem = async () => {
                if (!newItem.trim()) {
                    showMessage('Nová položka nemôže byť prázdna.');
                    return;
                }
                if (items.includes(newItem.trim())) {
                    showMessage('Táto položka už existuje.');
                    return;
                }

                try {
                    // Používame setDoc s merge: true, aby sme pridali do poľa bez prepísania iných polí
                    // Ak dokument neexistuje, vytvorí sa
                    console.log(`[ReferenceDataManager] Adding item "${newItem.trim()}" to ${categoryId}`);
                    await window.firebase.setDoc(categoryDocRef, {
                        values: window.firebase.arrayUnion(newItem.trim())
                    }, { merge: true });
                    setNewItem('');
                    showMessage('Položka úspešne pridaná!');
                } catch (error) {
                    console.error("Chyba pri pridávaní položky:", error);
                    showMessage(`Chyba pri pridávaní položky: ${error.message}`);
                }
            };

            const handleUpdateItem = async () => {
                if (!editingItem || !newItem.trim()) {
                    showMessage('Nová hodnota nemôže byť prázdna.');
                    return;
                }
                if (items.includes(newItem.trim()) && newItem.trim() !== editingItem.value) {
                    showMessage('Táto položka už existuje.');
                    return;
                }

                try {
                    // Odstránime starú hodnotu a pridáme novú
                    console.log(`[ReferenceDataManager] Updating item from "${editingItem.value}" to "${newItem.trim()}" in ${categoryId}`);
                    const updatedValues = items.map(item => item === editingItem.value ? newItem.trim() : item);
                    await window.firebase.setDoc(categoryDocRef, { values: updatedValues });
                    setEditingItem(null);
                    setNewItem('');
                    showMessage('Položka úspešne aktualizovaná!');
                } catch (error) {
                    console.error("Chyba pri aktualizácii položky:", error);
                    showMessage(`Chyba pri aktualizácii položky: ${error.message}`);
                }
            };

            const handleDeleteItem = async (itemToDelete) => {
                // Namiesto window.confirm použijeme náš MessageModal pre konzistentnosť UI
                // Pre jednoduchosť zatiaľ ponechávam window.confirm, ale v produkcii by sa nahradil modalom
                if (!window.confirm(`Naozaj chcete vymazať položku "${itemToDelete}"?`)) {
                    return;
                }
                try {
                    // Používame arrayRemove na odstránenie konkrétnej položky z poľa
                    console.log(`[ReferenceDataManager] Deleting item "${itemToDelete}" from ${categoryId}`);
                    await window.firebase.updateDoc(categoryDocRef, {
                        values: window.firebase.arrayRemove(itemToDelete)
                    });
                    showMessage('Položka úspešne vymazaná!');
                } catch (error) {
                    console.error("Chyba pri mazaní položky:", error);
                    showMessage(`Chyba pri mazaní položky: ${error.message}`);
                }
            };

            const startEditing = (item) => {
                setEditingItem({ value: item });
                setNewItem(item);
            };

            const cancelEditing = () => {
                setEditingItem(null);
                setNewItem('');
            };

            return (
                <div className="bg-white p-6 rounded-lg shadow-inner border border-gray-200 mb-6">
                    <h3 className="text-xl font-semibold text-blue-700 mb-4">{categoryLabel}</h3>
                    <div className="flex gap-2 mb-4">
                        <LabeledInput
                            id={`new-item-${categoryId}`}
                            placeholder={`Nová položka pre ${categoryLabel}`}
                            value={newItem}
                            onChange={(e) => setNewItem(e.target.value)}
                            className="flex-grow"
                        />
                        {editingItem ? (
                            <>
                                <button
                                    onClick={handleUpdateItem}
                                    className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition duration-200 shadow-sm"
                                >
                                    Uložiť úpravu
                                </button>
                                <button
                                    onClick={cancelEditing}
                                    className="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition duration-200 shadow-sm"
                                >
                                    Zrušiť
                                </button>
                            </>
                        ) : (
                            <button
                                onClick={handleAddItem}
                                className="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition duration-200 shadow-sm"
                            >
                                Pridať
                            </button>
                        )}
                    </div>
                    <ul className="list-disc pl-5 max-h-60 overflow-y-auto border border-gray-200 rounded-md p-3 bg-gray-50">
                        {items.length === 0 ? (
                            <li className="text-gray-500">Žiadne položky.</li>
                        ) : (
                            items.map((item, index) => (
                                <li key={item} className="flex justify-between items-center py-1.5 text-gray-800">
                                    <span>{item}</span>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => startEditing(item)}
                                            className="text-blue-600 hover:text-blue-800 text-sm"
                                        >
                                            Upraviť
                                        </button>
                                        <button
                                            onClick={() => handleDeleteItem(item)}
                                            className="text-red-600 hover:text-red-800 text-sm"
                                        >
                                            Vymazať
                                        </button>
                                    </div>
                                </li>
                            ))
                        )}
                    </ul>
                </div>
            );
        };

        // --- Komponent: pages/CiselniciPage.js ---
        function CiselniciPage({ showMessage, db, userId, isAuthReady, appId }) { // Prijímame appId ako prop
            console.log(`[CiselniciPage] Rendering. isAuthReady: ${isAuthReady}, db: ${!!db}, userId: ${userId}, appId: ${appId}`);
            const [activeTab, setActiveTab] = useState('manufacturers'); // Predvolená aktívna záložka

            // Definovanie všetkých kategórií číselníkov
            const categories = [
                { id: 'manufacturers', label: 'Výrobcovia' },
                { id: 'scales', label: 'Mierky' },
                { id: 'epochs', label: 'Epochy' },
                { id: 'administrations', label: 'Správy' },
                { id: 'depots', label: 'Depá' },
                { id: 'conditions', label: 'Stavy modelov' },
                { id: 'dealers', label: 'Obchodníci' },
                { id: 'couplingTypes', label: 'Typy spriahly' },
                { id: 'decoderInterfaces', label: 'Rozhrania dekodérov' },
                { id: 'decoderTypes', label: 'Typy dekodérov' },
                { id: 'decoderManufacturers', label: 'Výrobcovia dekodérov' },
                { id: 'wagonTypes', label: 'Typy vagónov' },
                { id: 'loadTypes', label: 'Typy nákladov' },
                { id: 'colors', label: 'Farby' },
                { id: 'trackTypes', label: 'Typy koľají' },
                { id: 'trackMaterials', label: 'Materiály koľají' },
                { id: 'trackSystems', label: 'Systémy koľají' },
                { id: 'signalCommunications', label: 'Komunikácia návestidiel' },
                { id: 'signalTypes', label: 'Typy návestidiel' },
                { id: 'signalKinds', label: 'Druhy návestidiel' },
                { id: 'figureTypes', label: 'Typy figúrok' },
                { id: 'lightingTypes', label: 'Typy osvetlenia' },
                { id: 'buildingMaterials', label: 'Materiály budov' },
                { id: 'packagingConditions', label: 'Stavy obalov' },
                { id: 'conditionRatings', label: 'Hodnotenia stavu' },
                { id: 'locomotiveTypes', label: 'Typy lokomotív' }, // DCC/Analog
                { id: 'carBrands', label: 'Značky áut' },
                { id: 'carConditions', label: 'Stavy áut' },
                { id: 'buildingTypes', label: 'Typy budov' },
            ];

            const selectedCategory = categories.find(cat => cat.id === activeTab);

            if (!isAuthReady || !appId) { // Kontrolujeme aj appId
                console.log("[CiselniciPage] isAuthReady or appId is false, showing loading message.");
                return (
                    <main className="flex-1 p-8 bg-gray-50 flex items-center justify-center">
                        <p className="text-3xl font-bold text-red-600 animate-pulse">
                            Inicializácia Firebase pre číselníky... Prosím počkajte.
                        </p>
                    </main>
                );
            }

            return (
                <main className="flex-1 p-8 bg-gray-50">
                    <h1 className="text-4xl font-extrabold text-blue-800 mb-8">Číselníky</h1>

                    <div className="bg-white p-6 rounded-xl shadow-lg border border-blue-100">
                        <div className="flex flex-wrap border-b border-blue-200 mb-6">
                            {categories.map(category => (
                                <button
                                    key={category.id}
                                    onClick={() => setActiveTab(category.id)}
                                    className={`py-2 px-4 text-lg font-medium ${activeTab === category.id ? 'border-b-2 border-blue-600 text-blue-800' : 'text-gray-600 hover:text-blue-800'}`}
                                >
                                    {category.label}
                                </button>
                            ))}
                        </div>

                        {selectedCategory && (
                            <ReferenceDataManager
                                categoryId={selectedCategory.id}
                                categoryLabel={selectedCategory.label}
                                db={db}
                                userId={userId}
                                showMessage={showMessage}
                                appId={appId} // Odovzdávame appId
                            />
                        )}
                        {!selectedCategory && (
                            <div className="p-4 bg-yellow-100 border border-yellow-400 text-yellow-700 rounded-md">
                                <p>Varovanie: Vybraná kategória číselníka nebola nájdená.</p>
                            </div>
                        )}
                    </div>
                </main>
            );
        }

        // --- Komponent: pages/PrintPage.js ---
        function PrintPage() {
            return (
                <main className="flex-1 p-8 bg-gray-50">
                    <h1 className="text-4xl font-extrabold text-blue-800 mb-8">Tlač</h1>
                    <p className="text-lg text-gray-700 leading-relaxed">
                        Tu budú možnosti pre tlač evidenčných kariet alebo iných zostáv.
                    </p>
                    <div className="mt-10 p-6 bg-white rounded-xl shadow-lg border border-blue-100">
                        <p className="text-blue-700 font-semibold text-xl">
                            <span className="text-blue-500 mr-2">🖨️</span> Pripravte si svoje modely na papier!
                        </p>
                    </div>
                </main>
            );
        }

        // --- Komponent: pages/SettingsPage.js ---
        function SettingsPage() {
            return (
                <main className="flex-1 p-8 bg-gray-50">
                    <h1 className="text-4xl font-extrabold text-blue-800 mb-8">Nastavenia</h1>
                    <p className="text-lg text-gray-700 leading-relaxed">
                        Spravujte tu nastavenia aplikácie, používateľské preferencie a ďalšie.
                    </p>
                    <div className="mt-10 p-6 bg-white rounded-xl shadow-lg border border-blue-100">
                        <p className="text-blue-700 font-semibold text-xl">
                            <span className="text-blue-500 mr-2">⚙️</span> Prispôsobte si aplikáciu podľa svojich potrieb.
                        </p>
                    </div>
                </main>
            );
        }

        // --- Komponent: ModelListTable.js ---
        function ModelListTable({ category, models, onSelectModel, selectedModelId }) {
            const filteredModels = models.filter(model => model.category === category);

            return (
                <div className="model-table-container">
                    <h2 className="text-xl font-semibold text-blue-700 mb-4">Zoznam modelov ({category})</h2>
                    {filteredModels.length === 0 ? (
                        <p className="text-gray-700 p-4 bg-white rounded-lg">Zatiaľ žiadne modely typu "{category}" nie sú uložené.</p>
                    ) : (
                        <table className="model-table bg-white">
                            <thead>
                                <tr>
                                    <th>Ev. číslo</th>
                                    <th>Názov</th>
                                    <th>Kategória</th>
                                    <th>Cena</th>
                                    <th>Výrobca</th>
                                    <th>Epocha</th>
                                    <th>Správa</th>
                                    <th>Depo</th>
                                    <th>Umiestnenie</th>
                                    <th>Stav obalu</th>
                                    <th>Hodnotenie stavu</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredModels.map((model) => (
                                    <tr
                                        key={model.id}
                                        onClick={() => onSelectModel(model.id)}
                                        className={selectedModelId === model.id ? 'selected' : ''}
                                    >
                                        <td>{model.evidencneCislo || model.evidencneCisloAuto || 'N/A'}</td>
                                        <td>{model.modelName}</td>
                                        <td>{model.category} {model.subCategory ? `(${model.subCategory})` : ''}</td>
                                        <td>{model.cenaModelu} €</td>
                                        <td>{model.manufacturer}</td>
                                        <td>{model.epocha || 'N/A'}</td>
                                        <td>{model.sprava || 'N/A'}</td>
                                        <td>{model.depo || 'N/A'}</td>
                                        <td>{model.location || 'N/A'}</td>
                                        <td>{model.packagingCondition || 'N/A'}</td>
                                        <td>{model.conditionRating || 'N/A'}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    )}
                </div>
            );
        }

        // --- Komponent: pages/ModelsPage.js ---
        function ModelsPage({ showMessage, db, userId, isAuthReady, allReferenceData }) {
            const [activeCategoryTab, setActiveCategoryTab] = useState('Lokomotíva');
            const [selectedModelId, setSelectedModelId] = useState(null);
            const [isEditing, setIsEditing] = useState(false);

            const lokomotivaFormRef = useRef();
            const vagonFormRef = useRef();
            const prislusenstvoFormRef = useRef();

            const [allModels, setAllModels] = useState([]);

            // V reálnej aplikácii by sa tieto importovali z príslušných Firebase modulov
            const {
                doc,
                addDoc,
                updateDoc,
                deleteDoc,
                onSnapshot,
                collection,
                query
            } = window.firebase;

            useEffect(() => {
                if (db && userId && isAuthReady) {
                    const modelsCollectionRef = collection(db, `artifacts/${__app_id}/users/${userId}/models`);
                    const q = query(modelsCollectionRef);

                    const unsubscribe = onSnapshot(q, (snapshot) => {
                        const fetchedModels = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setAllModels(fetchedModels);
                    }, (error) => {
                        console.error("Chyba pri načítaní modelov:", error);
                        showMessage(`Chyba pri načítaní modelov: ${error.message}`);
                    });

                    return () => unsubscribe();
                } else {
                    setAllModels([]);
                }
            }, [db, userId, isAuthReady, showMessage]);

            const handleFormSubmit = async (event) => {
                event.preventDefault();

                if (!db || !userId) {
                    showMessage("Chyba: Databáza alebo ID používateľa nie je k dispozícii.");
                    return;
                }

                let formData = null;
                if (activeCategoryTab === 'Lokomotíva' && lokomotivaFormRef.current) {
                    formData = lokomotivaFormRef.current.getCurrentFormData();
                } else if (activeCategoryTab === 'Vagón' && vagonFormRef.current) {
                    formData = vagonFormRef.current.getCurrentFormData();
                } else if (activeCategoryTab === 'Príslušenstvo' && prislusenstvoFormRef.current) {
                    formData = prislusenstvoFormRef.current.getCurrentFormData();
                }

                if (!formData) {
                    showMessage('Chyba: Dáta formulára neboli načítané.');
                    return;
                }

                try {
                    if (isEditing && selectedModelId) {
                        const modelDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/models`, selectedModelId);
                        await updateDoc(modelDocRef, {
                            ...formData,
                            updatedAt: new Date().toISOString(),
                        });
                        showMessage('Model bol úspešne aktualizovaný!');
                    } else {
                        if (allModels.length >= 5) {
                            showMessage("Dosiahli ste limit 5 modelov pre demo verziu. Pre neobmedzené modely si zakúpte predplatné!");
                            return;
                        }
                        const modelsCollectionRef = collection(db, `artifacts/${__app_id}/users/${userId}/models`);
                        const newModelRef = await addDoc(modelsCollectionRef, {
                            ...formData,
                            createdAt: new Date().toISOString(),
                        });
                        showMessage('Model bol úspešne pridaný!');
                        setSelectedModelId(newModelRef.id);
                    }
                    setIsEditing(false);
                } catch (error) {
                    console.error("Chyba pri ukladaní modelu do Firestore:", error);
                    showMessage(`Chyba pri ukladaní modelu: ${error.message}`);
                }
            };

            const handleDeleteModel = async () => {
                if (!selectedModelId) {
                    showMessage('Prosím, vyberte model na vymazanie.');
                    return;
                }
                if (!db || !userId) {
                    showMessage("Chyba: Databáza alebo ID používateľa nie je k dispozícii.");
                    return;
                }

                const confirmDelete = window.confirm('Naozaj chcete vymazať tento model?');
                if (confirmDelete) {
                    try {
                        const modelDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/models`, selectedModelId);
                        await deleteDoc(modelDocRef);
                        showMessage('Model bol úspešne vymazaný!');
                        setSelectedModelId(null);
                        setIsEditing(false);
                    } catch (error) {
                        console.error("Chyba pri mazaní modelu:", error);
                        showMessage(`Chyba pri mazaní modelu: ${error.message}`);
                    }
                }
            };

            const handleNewModel = () => {
                setSelectedModelId(null);
                setIsEditing(true);
            };

            const handleEditModel = () => {
                if (!selectedModelId) {
                    showMessage('Prosím, vyberte model na úpravu.');
                    return;
                }
                setIsEditing(true);
            };

            const handleCancelEdit = () => {
                setIsEditing(false);
                if (selectedModelId === null && allModels.length > 0) {
                    const firstModelInCategory = allModels.find(model => model.category === activeCategoryTab);
                    setSelectedModelId(firstModelInCategory ? firstModelInCategory.id : null);
                }
            };

            const currentDetailModel = selectedModelId ? allModels.find(model => model.id === selectedModelId) : null;

            return (
                <div className="bg-white p-8 rounded-xl shadow-lg border border-blue-100">
                    <h1 className="text-3xl font-bold text-blue-800 mb-6">Správa modelov</h1>

                    <div className="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200 mb-8">
                        <h2 className="text-xl font-semibold text-blue-700 mb-2">Filter</h2>
                        <p className="text-gray-700">Tu bude sekcia pre filtrovanie zoznamu modelov.</p>
                    </div>

                    <div className="flex border-b border-blue-200 mb-6">
                        <button
                            onClick={() => { setActiveCategoryTab('Lokomotíva'); setSelectedModelId(null); setIsEditing(false); }}
                            className={`py-2 px-4 text-lg font-medium ${activeCategoryTab === 'Lokomotíva' ? 'border-b-2 border-blue-600 text-blue-800' : 'text-gray-600 hover:text-blue-800'}`}
                        >
                            Lokomotívy
                        </button>
                        <button
                            onClick={() => { setActiveCategoryTab('Vagón'); setSelectedModelId(null); setIsEditing(false); }}
                            className={`py-2 px-4 text-lg font-medium ${activeCategoryTab === 'Vagón' ? 'border-b-2 border-blue-600 text-blue-800' : 'text-gray-600 hover:text-blue-800'}`}
                        >
                            Vagóny
                        </button>
                        <button
                            onClick={() => { setActiveCategoryTab('Príslušenstvo'); setSelectedModelId(null); setIsEditing(false); }}
                            className={`py-2 px-4 text-lg font-medium ${activeCategoryTab === 'Príslušenstvo' ? 'border-b-2 border-blue-600 text-blue-800' : 'text-gray-600 hover:text-blue-800'}`}
                        >
                            Príslušenstvo
                        </button>
                    </div>

                    <div className="flex justify-start mb-6">
                        {!isEditing && (
                            <button
                                type="button"
                                onClick={handleNewModel}
                                className="bg-green-600 text-white px-5 py-2.5 rounded-lg hover:bg-green-700 transition duration-200 shadow-md"
                            >
                                Pridať model
                            </button>
                        )}
                    </div>

                    <form onSubmit={handleFormSubmit}>
                        <div className="mb-8">
                            {activeCategoryTab === 'Lokomotíva' && (
                                <LokomotivaForm
                                    ref={lokomotivaFormRef}
                                    initialData={currentDetailModel}
                                    isEditMode={isEditing}
                                    showMessage={showMessage}
                                    allReferenceData={allReferenceData}
                                />
                            )}
                            {activeCategoryTab === 'Vagón' && (
                                <VagonForm
                                    ref={vagonFormRef}
                                    initialData={currentDetailModel}
                                    isEditMode={isEditing}
                                    showMessage={showMessage}
                                    allReferenceData={allReferenceData}
                                />
                            )}
                            {activeCategoryTab === 'Príslušenstvo' && (
                                <PrislusenstvoForm
                                    ref={prislusenstvoFormRef}
                                    initialData={currentDetailModel}
                                    isEditMode={isEditing}
                                    showMessage={showMessage}
                                    allReferenceData={allReferenceData}
                                />
                            )}

                            <div className="flex justify-end space-x-4 mt-6">
                                {selectedModelId && !isEditing && (
                                    <button
                                        type="button"
                                        onClick={handleEditModel}
                                        className="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700 transition duration-200 shadow-md"
                                    >
                                        Upraviť
                                    </button>
                                )}
                                {isEditing && (
                                    <>
                                        <button
                                            type="submit"
                                            className="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition duration-200 shadow-md text-lg font-semibold"
                                        >
                                            Uložiť model
                                        </button>
                                        <button
                                            type="button"
                                            onClick={handleCancelEdit}
                                            className="bg-gray-500 text-white px-5 py-2.5 rounded-lg hover:bg-gray-600 transition duration-200 shadow-md"
                                        >
                                            Zrušiť
                                        </button>
                                    </>
                                )}
                                {selectedModelId && !isEditing && (
                                    <button
                                        type="button"
                                        onClick={handleDeleteModel}
                                        className="bg-red-600 text-white px-5 py-2.5 rounded-lg hover:bg-red-700 transition duration-200 shadow-md"
                                    >
                                        Zmazať
                                    </button>
                                )}
                            </div>
                        </div>
                    </form>

                    <ModelListTable
                        category={activeCategoryTab}
                        models={allModels}
                        onSelectModel={(id) => { setSelectedModelId(id); setIsEditing(false); }}
                        selectedModelId={selectedModelId}
                    />
                </div>
            );
        }

        // --- Hlavný komponent aplikácie: App.js ---
        function App() {
            const [currentPage, setCurrentPage] = useState('models');
            const [modalMessage, setModalMessage] = useState(null);

            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [firebaseStatusMessage, setFirebaseStatusMessage] = useState('Inicializácia Firebase...');
            const [allReferenceData, setAllReferenceData] = useState({}); // Nový stav pre všetky číselníky
            const [appId, setAppId] = useState(null); // Nový stav pre appId

            useEffect(() => {
                let unsubscribeAuth = () => {};
                let unsubscribeRefData = () => {};

                const initializeFirebase = async () => {
                    try {
                        const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'rail-model-registry-production';
                        setAppId(currentAppId); // Nastavíme appId do stavu

                        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify({
                            apiKey: "AIzaSyAqIOEs-5bnew7vnbdKrPmwm2lT8p7pGn8",
                            authDomain: "railmodelregistryapp.firebaseapp.com",
                            projectId: "railmodelregistryapp",
                            storageBucket: "railmodelregistryapp.firebasestorage.app",
                            messagingSenderId: "33435632655",
                            appId: "1:33435632655:web:50fdb8969d453161bd4f7a",
                        }));
                        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                        if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
                            console.error("Firebase config is empty or placeholder. Please ensure __firebase_config is correctly set.");
                            setFirebaseStatusMessage("Chyba: Firebase konfigurácia chýba alebo je neplatná.");
                            return;
                        }

                        const app = window.firebase.initializeApp(firebaseConfig);
                        const firestore = window.firebase.getFirestore(app);
                        const firebaseAuth = window.firebase.getAuth(app);

                        setDb(firestore);
                        setAuth(firebaseAuth);

                        try {
                            if (initialAuthToken) {
                                await window.firebase.signInWithCustomToken(firebaseAuth, initialAuthToken);
                            } else {
                                await window.firebase.signInAnonymously(firebaseAuth);
                            }
                        } catch (error) {
                            console.error("Chyba pri prihlasovaní do Firebase:", error);
                            setFirebaseStatusMessage(`Chyba pri prihlasovaní: ${error.message}`);
                        }

                        unsubscribeAuth = window.firebase.onAuthStateChanged(firebaseAuth, (user) => {
                            if (user) {
                                setUserId(user.uid);
                                setIsAuthReady(true);
                                setFirebaseStatusMessage(`Firebase pripojené. Prihlásený ako: ${user.uid}`);
                            } else {
                                setUserId(null);
                                setIsAuthReady(true);
                                setFirebaseStatusMessage("Firebase pripojené. Neprihlásený používateľ (anonymné prihlásenie).");
                            }
                        });

                        // Načítanie číselníkov z verejnej kolekcie
                        const referenceDataCollectionRef = window.firebase.collection(firestore, `artifacts/${currentAppId}/public/data/referenceData`);
                        unsubscribeRefData = window.firebase.onSnapshot(referenceDataCollectionRef, (snapshot) => {
                            const fetchedData = {};
                            snapshot.docs.forEach(doc => {
                                fetchedData[doc.id] = doc.data().values || [];
                            });
                            setAllReferenceData(fetchedData);
                            console.log("[App] Reference data loaded:", fetchedData);
                        }, (error) => {
                            console.error("Chyba pri načítaní číselníkov:", error);
                            showMessage(`Chyba pri načítaní číselníkov: ${error.message}`);
                        });

                    } catch (error) {
                        console.error("Chyba pri inicializácii Firebase:", error);
                        setFirebaseStatusMessage(`Chyba pri inicializácii Firebase: ${error.message}`);
                    }
                };

                initializeFirebase();

                return () => {
                    unsubscribeAuth();
                    unsubscribeRefData();
                };
            }, []);

            const handleNavigate = (page) => {
                console.log(`[App] Navigating to: ${page}`);
                setCurrentPage(page);
            };

            const showMessage = (message) => {
                setModalMessage(message);
            };

            const closeMessageModal = () => {
                setModalMessage(null);
            };

            let pageContent;
            console.log(`[App] Rendering page: ${currentPage}`);
            switch (currentPage) {
                case 'home':
                    pageContent = <HomePage />;
                    break;
                case 'models':
                    if (!isAuthReady) {
                        pageContent = (
                            <main className="flex-1 p-8 bg-gray-50 flex items-center justify-center">
                                <p className="text-3xl font-bold text-red-600 animate-pulse">
                                    Inicializácia Firebase pre modely... Prosím počkajte.
                                </p>
                            </main>
                        );
                    } else {
                        pageContent = <ModelsPage showMessage={showMessage} db={db} userId={userId} isAuthReady={isAuthReady} allReferenceData={allReferenceData} />;
                    }
                    break;
                case 'search':
                    pageContent = <SearchPage />;
                    break;
                case 'exportCsv':
                    pageContent = <ExportCsvPage />;
                    break;
                case 'ciselnici':
                    // CiselniciPage už má svoju vlastnú kontrolu isAuthReady a teraz aj appId
                    pageContent = <CiselniciPage showMessage={showMessage} db={db} userId={userId} isAuthReady={isAuthReady} appId={appId} />;
                    break;
                case 'print':
                    pageContent = <PrintPage />;
                    break;
                case 'settings':
                    pageContent = <SettingsPage />;
                    break;
                default:
                    pageContent = <HomePage />;
            }

            return (
                <div className="min-h-screen bg-blue-50 flex flex-col">
                    <Header onNavigate={handleNavigate} authStatusMessage={firebaseStatusMessage} />
                    <div className="flex flex-1">
                        <Sidebar onNavigate={handleNavigate} />
                        <main className="flex-1 p-8 overflow-y-auto">
                            {pageContent}
                        </main>
                    </div>
                    <MessageModal message={modalMessage} onClose={closeMessageModal} />
                </div>
            );
        }

        // Vykreslenie hlavného komponentu React aplikácie do DOM
        try {
            ReactDOM.render(<App />, document.getElementById('root'));
        } catch (error) {
            console.error("Chyba pri vykresľovaní React aplikácie:", error);
            document.getElementById('root').innerHTML = `
                <div style="color: red; padding: 20px; font-size: 18px; text-align: center;">
                    <h1>Chyba pri načítaní aplikácie</h1>
                    <p>Nastala neočakávaná chyba pri inicializácii používateľského rozhrania. Skúste prosím obnoviť stránku.</p>
                    <p>Detail chyby: ${error.message}</p>
                </div>
            `;
        }
    </script>
</body>
</html>
